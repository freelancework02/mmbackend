<!-- Views/pages/home.ejs -->
<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Home | Maula Ali Research Centre</title>

  <!-- Tailwind via CDN (remove if you're already bundling Tailwind in your app) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Your global CSS (fonts, variables) -->
  <link rel="stylesheet" href="/assets/Style/fonts.css" />

  <style>
    /* Optional helpers to match your clamp utilities */
    .title-line-clamp-2 { display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
    .line-clamp-2 { display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
    :root{
      --primary-dark:#166534; /* adjust to your current theme if different */
      --secondary-brown:#783F1D;
    }
  </style>
</head>
<body class="min-h-screen bg-cover bg-center bg-no-repeat flex flex-col relative">

  <!-- Background layer -->
  <div class="inset-0 bg-cover bg-center bg-no-repeat opacity-100 z-10" style="background-image:url('/images/newbg.png')"></div>

  <!-- Header -->
  <header class="bg-[#783F1D] sticky top-0 z-50 shadow-md border-b border-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center py-4 relative">
        <!-- Left nav (desktop) -->
        <nav class="hidden md:flex gap-6 text-md font-semibold text-white tracking-wide">
          <a href="/" class="hover:opacity-[0.6]">Home</a>
          <a href="/about" class="hover:opacity-[0.6]">About</a>
          <a href="/events" class="hover:opacity-[0.6]">News & Event</a>
          <a href="/book" class="hover:opacity-[0.6]">Books</a>
        </nav>

        <!-- Center logo -->
        <div class="absolute left-1/2 transform -translate-x-1/2 -bottom-7 bg-white rounded-full p-1 shadow-lg border border-green-100 z-10">
          <img src="/images/marc.png" alt="Logo" class="w-16 h-16 rounded-full object-contain" />
        </div>

        <!-- Right nav (desktop) -->
        <nav class="hidden md:flex gap-6 text-md font-semibold text-white tracking-wide">
          <a href="/article" class="hover:opacity-[0.6]">Articles</a>
          <a href="/qa" class="hover:opacity-[0.6]">Question Answer</a>
          <!-- <a href="/requestbook" class="hover:opacity-[0.6]">Request a Book</a> -->
          <a href="/contact" class="hover:opacity-[0.6]">Contact</a>
        </nav>

        <!-- Mobile menu button -->
        <div class="md:hidden">
          <button id="mobileMenuBtn" class="text-white focus:outline-none" aria-label="Toggle menu">
            <svg class="w-7 h-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path id="mobileMenuIcon" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          </button>
        </div>
      </div>

      <!-- Mobile dropdown -->
      <div id="mobileMenu" class="md:hidden transition-all overflow-hidden max-h-0 opacity-0">
        <div class="flex flex-col gap-3 py-4 px-2 bg-[#783F1D] text-white rounded-b-xl">
          <a href="/" class="px-4 py-2">Home</a>
          <a href="/about" class="px-4 py-2 hover:text-white rounded">About</a>
          <a href="/books" class="px-4 py-2 hover:text-white rounded">Books</a>
          <a href="/events" class="px-4 py-2 hover:text-white rounded">News & Event</a>
          <a href="/article" class="px-4 py-2 hover:text-white rounded">Articles</a>
          <a href="/qa" class="px-4 py-2 hover:text-white rounded">Question Answer</a>
          <!-- <a href="/requestbook" class="px-4 py-2 hover:text-white rounded">Request a Book</a> -->
          <a href="/contact" class="px-4 py-2 hover:text-white rounded">Contact</a>
        </div>
      </div>
    </div>
  </header>

  <!-- Page content -->
  <div class="bg-slate-100 text-gray-700 antialiased w-full">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-10 pb-20">
      <!-- Hero -->
      <section class="py-12 mb-10 text-center">
        <h1 class="text-4xl md:text-5xl font-bold text-green-700 mb-5">Explore Our Collection</h1>
        <p class="text-lg text-gray-600 leading-relaxed max-w-2xl mx-auto text-left sm:text-center">
          Discover rare manuscripts and insightful publications from the Maula Ali Research Centre.
        </p>
      </section>

      <!-- Search (visual only, like your React) -->
      <div class="relative max-w-xl mx-auto mb-12">
        <input
          type="text"
          id="searchVisual"
          class="w-full bg-white py-4 pl-6 pr-12 rounded-full shadow-md text-base text-gray-700 placeholder-gray-500 focus:ring-2 focus:ring-green-500 focus:outline-none transition-shadow font-gulzar text-right"
          placeholder="تلاش کریں..."
        />
        <!-- search icon -->
        <svg class="absolute right-5 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.3-4.3"></path>
        </svg>
      </div>

      <!-- Filters -->
      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6 mb-10">
        <div>
          <label class="block mb-1 font-medium text-slate-700 gulzartext text-sm">Writer</label>
          <div class="relative cursor-pointer">
            <select id="filterWriter"
              class="appearance-none bg-slate-50 cursor-pointer w-full border border-slate-300 rounded-md py-2 px-3 text-slate-700 gulzartext focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition">
              <option value="">All Writers</option>
            </select>
            <svg class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 text-slate-700" viewBox="0 0 24 24" fill="none">
              <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2"/>
            </svg>
          </div>
        </div>

        <div>
          <label class="block mb-1 font-medium text-slate-700 gulzartext text-sm">Translator</label>
          <div class="relative">
            <select id="filterTranslator"
              class="appearance-none bg-slate-50 w-full border border-slate-300 rounded-md py-2 px-3 text-slate-700 gulzartext focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition">
              <option value="">All Translators</option>
            </select>
            <svg class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 text-slate-700" viewBox="0 0 24 24" fill="none">
              <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2"/>
            </svg>
          </div>
        </div>

        <div>
          <label class="block mb-1 font-medium text-slate-700 gulzartext text-sm">Language</label>
          <div class="relative">
            <select id="filterLanguage"
              class="appearance-none bg-slate-50 w-full border border-slate-300 rounded-md py-2 px-3 text-slate-700 gulzartext focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition">
              <option value="">All Languages</option>
            </select>
            <svg class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 text-slate-700" viewBox="0 0 24 24" fill="none">
              <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2"/>
            </svg>
          </div>
        </div>

        <div>
          <label class="block mb-1 font-medium text-slate-700 gulzartext text-sm">Sort By</label>
          <div class="relative">
            <select id="filterSorting"
              class="appearance-none bg-slate-50 w-full border border-slate-300 rounded-md py-2 px-3 text-slate-700 gulzartext focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition">
              <option value="latest">Latest</option>
              <option value="oldest">Oldest</option>
              <option value="title-asc">Title (A-Z)</option>
              <option value="title-desc">Title (Z-A)</option>
            </select>
            <svg class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 text-slate-700" viewBox="0 0 24 24" fill="none">
              <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2"/>
            </svg>
          </div>
        </div>
      </div>

      <!-- View toggle -->
      <div class="flex justify-end items-center mb-8 space-x-3">
        <button id="btnGrid"
          class="p-2.5 rounded-full bg-green-600 text-white"
          title="Grid view">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
          </svg>
        </button>
        <button id="btnList"
          class="p-2.5 rounded-full bg-white text-gray-500 hover:bg-gray-100"
          title="List view">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" clip-rule="evenodd"
              d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z"></path>
          </svg>
        </button>
      </div>

      <!-- Books container -->
      <!-- TWO COLS on mobile & tablet, 3/4 on larger screens -->
      <div id="booksContainer" class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8 mb-10"></div>

      <!-- Loading spinner for infinite scroll -->
      <div id="scrollSpinner" class="hidden flex justify-center py-6">
        <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-green-500"></div>
      </div>

      <!-- Empty state -->
      <div id="emptyState" class="hidden text-center py-10">
        <p class="text-gray-600">No books found matching your filters.</p>
      </div>
    </div>
  </div>


    <!-- Mobile Bottom Navigation Bar -->
 <div id="mobile-navbar"
     class="fixed bottom-0 left-0 right-0 bg-white shadow-xl z-40 lg:hidden rounded-t-2xl border-t border-gray-200">
  <nav class="flex justify-around items-center h-16 text-gray-400">

    <!-- Home -->
    <a href="/" class="mobile-nav-item flex flex-col items-center justify-center p-2 text-sm 
        hover:text-[var(--primary-dark)] transition-colors duration-200">
      <i class="fas fa-home text-lg mobile-nav-icon"></i>
      <span class="mt-1 mobile-nav-text">Home</span>
    </a>

    <!-- Q&A (Updated from About) -->
    <a href="/qa" class="mobile-nav-item flex flex-col items-center justify-center p-2 text-sm
        hover:text-[var(--primary-dark)] transition-colors duration-200">
      <i class="fas fa-question-circle text-lg mobile-nav-icon"></i>
      <span class="mt-1 mobile-nav-text">Q&A</span>
    </a>

    <!-- Books -->
    <a href="/book" class="mobile-nav-item flex flex-col items-center justify-center p-2 text-sm
        hover:text-[var(--primary-dark)] transition-colors duration-200">
      <i class="fas fa-book text-lg mobile-nav-icon"></i>
      <span class="mt-1 mobile-nav-text">Books</span>
    </a>

    <!-- Articles -->
    <a href="/article" class="mobile-nav-item flex flex-col items-center justify-center p-2 text-sm
        hover:text-[var(--primary-dark)] transition-colors duration-200">
      <i class="fas fa-newspaper text-lg mobile-nav-icon"></i>
      <span class="mt-1 mobile-nav-text">Articles</span>
    </a>

    <!-- Gallery (Updated from Contact) -->
    <a href="/gallery" class="mobile-nav-item flex flex-col items-center justify-center p-2 text-sm
        hover:text-[var(--primary-dark)] transition-colors duration-200">
      <i class="fas fa-images text-lg mobile-nav-icon"></i>
      <span class="mt-1 mobile-nav-text">Gallery</span>
    </a>

  </nav>
</div>

  <script>
    // ===== API endpoints =====
    const API = {
      writers: "https://minaramasjid-backend.onrender.com/api/writers",
      translators: "https://minaramasjid-backend.onrender.com/api/translators",
      languages: "https://minaramasjid-backend.onrender.com/api/languages/language",
      books: "https://minaramasjid-backend.onrender.com/api/books",
      bookCover: (id) => `https://minaramasjid-backend.onrender.com/api/books/cover/${id}`,
      attachment: (id) => `https://minaramasjid-backend.onrender.com/api/books/attachment/${id}`,
    };

    // ===== State =====
    const booksPerPage = 8;
    let allBooks = [];
    let filteredBooks = [];
    let displayedBooks = [];
    let page = 1;
    let hasMore = true;
    let loading = false;
    let initialLoad = true;
    let viewMode = "grid";

    const filters = {
      writer: "",
      translator: "",
      language: "",
      sorting: "latest",
    };

    // ===== Elements =====
    const mobileMenuBtn = document.getElementById("mobileMenuBtn");
    const mobileMenuIcon = document.getElementById("mobileMenuIcon");
    const mobileMenu = document.getElementById("mobileMenu");

    const filterWriter = document.getElementById("filterWriter");
    const filterTranslator = document.getElementById("filterTranslator");
    const filterLanguage = document.getElementById("filterLanguage");
    const filterSorting = document.getElementById("filterSorting");

    const btnGrid = document.getElementById("btnGrid");
    const btnList = document.getElementById("btnList");

    const container = document.getElementById("booksContainer");
    const scrollSpinner = document.getElementById("scrollSpinner");
    const emptyState = document.getElementById("emptyState");

    // ===== Utils =====
    const slugify = (text) => String(text || "")
      .toLowerCase().trim()
      .replace(/\s+/g, '-')
      .replace(/[.,\/#!$%\^&\*;:{}=\_`~()؟"’”’']/g, '')
      .replace(/-+/g, '-');

    const isUrdu = (text) => /[\u0600-\u06FF]/.test(String(text || ""));

    function sortBooks(list, mode) {
      const arr = [...list];
      if (mode === "latest") {
        arr.sort((a, b) => new Date(b.createdAt || b.createdOn || 0) - new Date(a.createdAt || a.createdOn || 0));
      } else if (mode === "oldest") {
        arr.sort((a, b) => new Date(a.createdAt || a.createdOn || 0) - new Date(b.createdAt || b.createdOn || 0));
      } else if (mode === "title-asc") {
        arr.sort((a, b) => String(a.title || "").localeCompare(String(b.title || "")));
      } else if (mode === "title-desc") {
        arr.sort((a, b) => String(b.title || "").localeCompare(String(a.title || "")));
      }
      return arr;
    }

    function escapeHtml(str) {
      return String(str ?? '')
        .replace(/&/g, "&amp;").replace(/</g, "&lt;")
        .replace(/>/g, "&gt;").replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // ===== Mobile menu =====
    mobileMenuBtn.addEventListener("click", () => {
      const open = mobileMenu.classList.contains("max-h-screen");
      if (open) {
        mobileMenu.classList.remove("max-h-screen", "opacity-100");
        mobileMenu.classList.add("max-h-0", "opacity-0");
        mobileMenuIcon.setAttribute("d", "M4 6h16M4 12h16M4 18h16");
      } else {
        mobileMenu.classList.remove("max-h-0", "opacity-0");
        mobileMenu.classList.add("max-h-screen", "opacity-100");
        mobileMenuIcon.setAttribute("d", "M6 18L18 6M6 6l12 12");
      }
    });

    // ===== View mode =====
    function setViewMode(mode) {
      viewMode = mode;
      if (mode === "list") {
        // Container becomes list
        container.className = "flex flex-col space-y-6 mb-10";
        btnGrid.className = "p-2.5 rounded-full bg-white text-gray-500 hover:bg-gray-100";
        btnList.className = "p-2.5 rounded-full bg-green-600 text-white";
        // adjust existing cards
        container.querySelectorAll(".book-card").forEach(card => {
          card.classList.remove("flex-col");
          card.classList.add("sm:flex", "sm:max-h-40");
          const imgWrap = card.querySelector(".card-image-wrap");
          imgWrap.className = "sm:w-36 flex-shrink-0 h-full";
        });
      } else {
        // GRID: 2 cols on mobile & tablet, 3/4 on larger screens
        container.className = "grid grid-cols-2 sm:grid-cols-2 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8 mb-10";
        btnGrid.className = "p-2.5 rounded-full bg-green-600 text-white";
        btnList.className = "p-2.5 rounded-full bg-white text-gray-500 hover:bg-gray-100";
        container.querySelectorAll(".book-card").forEach(card => {
          card.classList.remove("sm:flex", "sm:max-h-40");
          card.classList.add("flex-col");
          const imgWrap = card.querySelector(".card-image-wrap");
          imgWrap.className = "h-64 w-full";
        });
      }
    }

    btnGrid.addEventListener("click", () => setViewMode("grid"));
    btnList.addEventListener("click", () => setViewMode("list"));

    // ===== Filters =====
    function updateFilter(name, value) {
      filters[name] = value;
      applyFilters();
    }

    filterWriter.addEventListener("change", (e) => updateFilter("writer", e.target.value));
    filterTranslator.addEventListener("change", (e) => updateFilter("translator", e.target.value));
    filterLanguage.addEventListener("change", (e) => updateFilter("language", e.target.value));
    filterSorting.addEventListener("change", (e) => updateFilter("sorting", e.target.value));

    function applyFilters() {
      let out = [...allBooks];

      if (filters.writer) {
        const w = filters.writer.trim().toLowerCase();
        out = out.filter(b => String(b.author || "").trim().toLowerCase() === w);
      }
      if (filters.translator) {
        const t = filters.translator.trim().toLowerCase();
        out = out.filter(b => String((b.translator && b.translator.name) || b.translator || "").toLowerCase() === t);
      }
      if (filters.language) {
        const l = filters.language.trim().toLowerCase();
        out = out.filter(b => String(b.language || "").toLowerCase() === l);
      }

      out = sortBooks(out, filters.sorting);

      filteredBooks = out;
      page = 1;
      hasMore = filteredBooks.length > 0;
      container.innerHTML = "";
      displayedBooks = filteredBooks.slice(0, booksPerPage);
      renderBooks(displayedBooks);

      emptyState.classList.toggle("hidden", filteredBooks.length !== 0);
    }

    // ===== Rendering =====
    function createBookCard(book) {
      const card = document.createElement("div");
      card.className = "book-card cursor-pointer bg-white rounded-xl shadow-lg overflow-hidden transition-transform hover:scale-[1.02] flex flex-col";

      // click => navigate
      card.addEventListener("click", () => {
        const url = `/bookdetail/${book.id}/${slugify(book.title)}`;
        window.location.href = url;
      });

      const langBadge = /[ء-ي\u0600-\u06FF]/.test(book.title) ? "Urdu" : "English";

      card.innerHTML = `
        <div class="card-image-wrap h-64 w-full">
          <img
            src="${API.bookCover(book.id)}"
            alt="Cover of ${escapeHtml(book.title || "")}"
            class="w-full h-full object-cover"
            onerror="this.onerror=null;this.src='/Sliderimage/sampleimg.jpeg';"
          />
        </div>
        <div class="p-5 flex flex-col flex-grow">
          <h3 class="text-green-700 text-lg font-semibold mb-1.5 heading">${escapeHtml(book.title || "")}</h3>
          <div class="mb-4">
            <span class="text-xs bg-amber-100 text-amber-700 border border-amber-200 px-2.5 py-0.5 rounded-full font-medium">${langBadge}</span>
          </div>

          <!-- Writer / Translator block added, with fallbacks to 'testingaaaa' -->
          <div class="text-gray-500 text-sm space-y-2 mt-2">
            <p>
              <i class="fas fa-pen-nib mr-2"></i>
              <strong class="font-bold">Writer:</strong>
              ${escapeHtml(book.author || 'testingaaaa')}
            </p>
            <p>
              <i class="fas fa-language mr-2"></i>
              <strong class="font-bold">Translator:</strong>
              ${escapeHtml((book.translator && book.translator.name) || book.translator || 'testingaaaa')}
            </p>
          </div>

          <!-- Keep your buttons exactly as-is -->
          <div class="mt-auto flex gap-2 pt-4">
            <button class="cursor-pointer bg-green-600 text-white px-2.5 py-1 rounded-full text-xs">Read More</button>
            <a href="${API.attachment(book.id)}" target="_blank" rel="noopener noreferrer"
               class="cursor-pointer bg-amber-400 text-gray-800 px-2.5 py-1 rounded-full text-xs"
               onclick="event.stopPropagation()">Download</a>
          </div>
        </div>
      `;

      return card;
    }

    function renderBooks(list) {
      const frag = document.createDocumentFragment();
      list.forEach(b => frag.appendChild(createBookCard(b)));
      container.appendChild(frag);
      // re-apply current view mode to new nodes
      setViewMode(viewMode);
    }

    // ===== Pagination / Infinite scroll =====
    function loadMore() {
      if (!hasMore || loading) return;
      loading = true;
      scrollSpinner.classList.remove("hidden");

      const nextPage = page + 1;
      const start = (nextPage - 1) * booksPerPage;
      const end = start + booksPerPage;
      const chunk = filteredBooks.slice(start, end);

      setTimeout(() => {
        if (chunk.length) {
          renderBooks(chunk);
          displayedBooks = displayedBooks.concat(chunk);
          page = nextPage;
          hasMore = end < filteredBooks.length;
        } else {
          hasMore = false;
        }
        scrollSpinner.classList.add("hidden");
        loading = false;
      }, 400);
    }

    window.addEventListener("scroll", () => {
      const nearBottom = window.innerHeight + document.documentElement.scrollTop >= (document.documentElement.offsetHeight - 300);
      if (nearBottom) loadMore();
    });

    // ===== Initial load =====
    (async function init() {
      try {
        loading = true;
        initialLoad = true;

        const [wRes, tRes, lRes, bRes] = await Promise.all([
          fetch(API.writers),
          fetch(API.translators),
          fetch(API.languages),
          fetch(API.books),
        ]);

        const [writers, translators, languages, books] = await Promise.all([
          wRes.json(), tRes.json(), lRes.json(), bRes.json()
        ]);

        // populate filters
        writers.forEach(w => {
          const opt = document.createElement("option");
          opt.value = w.name; opt.textContent = w.name;
          filterWriter.appendChild(opt);
        });

        translators.forEach(t => {
          const opt = document.createElement("option");
          opt.value = t.name; opt.textContent = t.name;
          filterTranslator.appendChild(opt);
        });

        languages.forEach(l => {
          const opt = document.createElement("option");
          opt.value = l.language; opt.textContent = l.language;
          filterLanguage.appendChild(opt);
        });

        allBooks = Array.isArray(books) ? books : [];
        // initial sort+render (latest)
        filteredBooks = sortBooks(allBooks, filters.sorting);
        displayedBooks = filteredBooks.slice(0, booksPerPage);
        renderBooks(displayedBooks);
        hasMore = filteredBooks.length > booksPerPage;

        // default view
        setViewMode("grid");

      } catch (err) {
        console.error("Error fetching data:", err);
        emptyState.classList.remove("hidden");
      } finally {
        loading = false;
        initialLoad = false;
      }
    })();
  </script>
</body>
</html>
