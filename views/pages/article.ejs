<!-- views/articles.ejs -->
<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Articles | Maula Ali Research Center</title>
  <meta name="description" content="minaramasjid.com" />
  <link rel="icon" href="/images/marc.png" type="image/x-icon" />

  <!-- Open Graph -->
  <meta property="og:type" content="website" />
  <meta property="og:url" content="minaramasjid.com" />
  <meta property="og:title" content="Articles | Maula Ali Research Center" />
  <meta property="og:description" content="minaramasjid.com" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:url" content="minaramasjid.com" />
  <meta name="twitter:title" content="Articles | Maula Ali Research Center" />
  <meta name="twitter:description" content="minaramasjid.com" />

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Your fonts/css -->
  <link rel="stylesheet" href="/assets/Style/fonts.css">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Flex:opsz,wght@8..144,300;8..144,400;8..144,600;8..144,700&family=Gulzar&family=Scheherazade+New:wght@400;700&display=swap" rel="stylesheet">
  <link rel="preload" as="font" href="https://res.cloudinary.com/awescreative/raw/upload/v1749150996/Awes/naatfont.ttf" type="font/ttf" crossorigin>

  <style>
    :root{
      --font-latin: "Roboto Flex", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      --font-urdu: "NaatFont", "Gulzar", "Scheherazade New", "Amiri", serif;
      --text-base: #0f172a;
    }
    html, body { font-family: var(--font-latin); color: var(--text-base); }

    @font-face{
      font-family:"NaatFont";
      src:url("https://res.cloudinary.com/awescreative/raw/upload/v1749150996/Awes/naatfont.ttf") format("truetype");
      font-weight: normal; font-style: normal; font-display: swap;
    }

    .gulzartext, .arabic-text, [lang="ur"], .rtl-urdu, [dir="rtl"] .urdu {
      font-family: var(--font-urdu);
      font-variant-ligatures: contextual;
      -webkit-font-smoothing: antialiased;
    }

    .heading, .card-title { font-family: var(--font-urdu); font-weight: 700; }
    .sub-heading { font-family: var(--font-urdu); font-weight: 600; }

    .text-description {
      font-family: var(--font-latin);
      font-size: 0.95rem;
      line-height: 1.4;
      color: #334155;
    }
    .text-description.gulzartext {
      font-family: var(--font-urdu) !important;
    }

    .title-line-clamp-2 { display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
    .line-clamp-2 { display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
    .arabic-text { font-feature-settings: "calt"; }
    .serif { font-family: ui-serif, Georgia, Cambria, "Times New Roman", Times, serif; }

    #gridViewButton { background:#05966922; color:#065f46; }
    #listViewButton { background:#e2e8f0; color:#334155; }
    .btn-active { background:#059669 !important; color:#fff !important; }
    .btn-inactive { background:#e2e8f0 !important; color:#334155 !important; }
  </style>
</head>

<body class="bg-slate-100 bg-opacity-90" style="background-image:url('/images/newbg.png'); background-blend-mode:overlay;">

  <!-- Header / Navbar -->
  <header class="bg-white shadow-sm sticky top-0 z-50">
    <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="relative flex items-center justify-between h-20">
        <!-- Mobile Menu Button (lg:hidden) -->
        <div class="absolute inset-y-0 left-0 flex items-center lg:hidden z-50">
          <button
            id="mobile-menu-button"
            type="button"
            class="inline-flex items-center justify-center p-2 rounded-md bg-white/90 border border-slate-200 text-slate-800 hover:bg-white focus:outline-none focus:ring-2 focus:ring-inset focus:ring-emerald-500"
            aria-controls="mobile-menu"
            aria-expanded="false"
            aria-label="Toggle menu"
          >
            <span class="sr-only">Open main menu</span>

            <!-- Hamburger icon (shown when aria-expanded="false") -->
            <svg class="h-6 w-6 block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
            </svg>

            <!-- Close icon (shown when aria-expanded="true") -->
            <svg class="h-6 w-6 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>

        <!-- Mobile Logo (lg:hidden) -->
        <div class="flex-1 flex items-center justify-center lg:hidden">
          <a href="/" class="flex-shrink-0">
            <img class="h-12 w-auto" src="https://minaramasjid.com/assets/image/logo/marc.png" alt="Maula Ali Research Center Logo">
          </a>
        </div>

        <!-- Desktop Menu (hidden lg:flex) -->
        <div class="hidden lg:flex lg:items-center lg:space-x-4">
          <a href="/" class="text-gray-700 hover:text-primary-light px-3 py-2 rounded-md text-sm font-medium transition-colors duration-200">Home</a>
          <a href="/about" class="text-gray-700 hover:text-primary-light px-3 py-2 rounded-md text-sm">About</a>
          <a href="/events" class="text-gray-700 hover:text-primary-light px-3 py-2 rounded-md text-sm font-medium transition-colors duration-200">News & Events</a>
          <a href="/book" class="text-gray-700 hover:text-primary-light px-3 py-2 rounded-md text-sm font-medium transition-colors duration-200">Books</a>
        </div>

        <!-- Desktop Logo (hidden lg:flex) -->
        <div class="hidden lg:flex lg:flex-shrink-0 mx-6">
          <a href="/">
            <img class="h-16 w-auto" src="https://minaramasjid.com/assets/image/logo/marc.png" alt="Maula Ali Research Center Logo">
          </a>
        </div>

        <!-- Desktop Menu Right (hidden lg:flex) -->
        <div class="hidden lg:flex lg:items-center lg:space-x-4">
          <a href="/article" class="text-gray-700 hover:text-primary-light px-3 py-2 rounded-md text-sm font-medium transition-colors duration-200" aria-current="page">Articles</a>
          <a href="/qa" class="text-gray-700 hover:text-primary-light px-3 py-2 rounded-md text-sm font-medium transition-colors duration-200">Question Answer</a>
          <a href="/contact" class="text-gray-700 hover:text-primary-light px-3 py-2 rounded-md text-sm font-medium transition-colors duration-200">Contact</a>
        </div>

        <!-- Mobile Search (Placeholder) -->
        <div class="absolute inset-y-0 right-0 flex items-center pr-2 lg:hidden">
          <button class="p-2 rounded-full text-gray-500 hover:text-gray-900">
            <i class="fas fa-search fa-fw"></i>
          </button>
        </div>
      </div>
    </nav>

    <!-- Mobile Menu, show/hide based on menu state. -->
    <div class="lg:hidden hidden" id="mobile-menu">
      <div class="px-2 pt-2 pb-3 space-y-1">
        <a href="/" class="text-gray-700 hover:bg-gray-100 hover:text-gray-900 block px-3 py-2 rounded-md text-base font-medium">Home</a>
        <a href="/about" class="text-primary-light bg-gray-100 block px-3 py-2 rounded-md text-base font-medium" >About</a>
        <a href="/events" class="text-gray-700 hover:bg-gray-100 hover:text-gray-900 block px-3 py-2 rounded-md text-base font-medium">News & Events</a>
        <a href="/book" class="text-gray-700 hover:bg-gray-100 hover:text-gray-900 block px-3 py-2 rounded-md text-base font-medium">Books</a>
        <a href="/article" class="text-gray-700 hover:bg-gray-100 hover:text-gray-900 block px-3 py-2 rounded-md text-base font-medium">Articles</a>
        <a href="/qa" class="text-gray-700 hover:bg-gray-100 hover:text-gray-900 block px-3 py-2 rounded-md text-base font-medium">Question Answer</a>
        <a href="/contact" class="text-gray-700 hover:bg-gray-100 hover:text-gray-900 block px-3 py-2 rounded-md text-base font-medium">Contact</a>
      </div>
    </div>
  </header>

  <!-- Loading screen -->
  <div id="pageLoader" class="flex flex-col justify-center items-center h-screen space-y-6">
    <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-emerald-500"></div>
    <div class="amiri-regular text-2xl text-emerald-700 font-semibold arabic-text">صَلَّى ٱللّٰهُ عَلَيْهِ وَآلِهِ وَسَلَّمَ</div>
  </div>

  <!-- Page content -->
  <div id="pageContent" class="hidden relative z-10 container mx-auto px-4 py-8">
    <header class="text-center mb-10">
      <h1 class="text-4xl md:text-5xl font-bold text-slate-800 mb-4 gulzartext mt-10">مضامین</h1>
      <h1 class="text-4xl md:text-5xl font-bold text-slate-800 mb-4">Articles</h1>
      <p class="max-w-3xl mx-auto text-slate-600 text-base md:text-lg">
        Discover a wealth of Islamic knowledge, from insightful articles to in-depth research. Explore the rich
        heritage of Islam and gain a deeper understanding of its teachings and practices.
      </p>
    </header>

    <!-- Topic chips -->
    <div class="flex flex-wrap justify-center gap-3 mb-12">
      <div id="chipAll" class="bg-emerald-100 px-4 py-2 rounded-full flex items-center gap-2 text-emerald-700 shadow-sm hover:bg-emerald-200 hover:shadow-md transform hover:-translate-y-0.5 transition-all duration-200 cursor-pointer">
        <span class="serif font-medium">All</span>
        <span id="allCount" class="bg-emerald-600 text-white rounded-full px-2.5 py-0.5 text-xs font-semibold">0</span>
      </div>
      <!-- Topic chips will be shown only when user selects a topic -->
      <div id="chipTopic1" class="hidden bg-emerald-100 px-4 py-2 rounded-full items-center gap-2 text-emerald-700 shadow-sm hover:bg-emerald-200 hover:shadow-md transform hover:-translate-y-0.5 transition-all duration-200 cursor-pointer">
        <span class="gulzartext font-medium" id="chipTopic1Name"></span>
        <span id="chipTopic1Count" class="bg-emerald-600 text-white rounded-full px-2.5 py-0.5 text-xs font-semibold">0</span>
      </div>
      <div id="chipTopic2" class="hidden bg-emerald-100 px-4 py-2 rounded-full items-center gap-2 text-emerald-700 shadow-sm hover:bg-emerald-200 hover:shadow-md transform hover:-translate-y-0.5 transition-all duration-200 cursor-pointer">
        <span class="gulzartext font-medium" id="chipTopic2Name"></span>
        <span id="chipTopic2Count" class="bg-emerald-600 text-white rounded-full px-2.5 py-0.5 text-xs font-semibold">0</span>
      </div>
    </div>

    <div class="flex flex-col overflow-hidden lg:flex-row gap-8">
      <!-- Sidebar -->
      <aside class="w-full lg:w-64 bg-white rounded-xl shadow-lg p-5 h-fit sticky top-8 flex-shrink-0">
        <div class="relative mb-6">
          <input type="text" id="searchInput" placeholder="تلاش کریں"
                 class="cursor-pointer gulzartext bg-slate-50 w-full py-2 px-3 pr-10 border border-slate-300 rounded-full text-slate-700 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition text-right" />
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
               viewBox="0 0 24 24" fill="none" stroke="currentColor"
               stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
               class="lucide lucide-search absolute right-3 top-1/2 -translate-y-1/2 h-5 w-5 text-slate-400">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.3-4.3"></path>
          </svg>
        </div>

        <div class="space-y-4">
          <div>
            <label class="block mb-1 font-medium text-slate-700 gulzartext text-sm">Writer</label>
            <div class="relative">
              <select id="filterWriter"
                      class="cursor-pointer appearance-none bg-slate-50 w-full border border-slate-300 rounded-md py-2 px-3 text-slate-700 gulzartext focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition">
                <option value="">Select Writer</option>
              </select>
              <svg class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 text-slate-700" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2"/></svg>
            </div>
          </div>

          <div>
            <label class="block mb-1 font-medium text-slate-700 gulzartext text-sm">Translator</label>
            <div class="relative">
              <select id="filterTranslator"
                      class="cursor-pointer appearance-none bg-slate-50 w-full border border-slate-300 rounded-md py-2 px-3 text-slate-700 gulzartext focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition">
                <option value="">Select Translator</option>
              </select>
              <svg class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 text-slate-700" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2"/></svg>
            </div>
          </div>

          <div>
            <label class="block mb-1 font-medium text-slate-700 gulzartext text-sm">Sorting</label>
            <div class="relative">
              <select id="filterSorting"
                      class="cursor-pointer appearance-none bg-slate-50 w-full border border-slate-300 rounded-md py-2 px-3 text-slate-700 gulzartext focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition">
                <option value="latest">Latest</option>
                <option value="oldest">Oldest</option>
              </select>
              <svg class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 text-slate-700" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2"/></svg>
            </div>
          </div>

          <div>
            <label class="block mb-1 font-medium text-slate-700 gulzartext text-sm">Language</label>
            <div class="relative">
              <select id="filterLanguage"
                      class="cursor-pointer appearance-none bg-slate-50 w-full border border-slate-300 rounded-md py-2 px-3 text-slate-700 gulzartext focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition">
                <option value="">Select Language</option>
              </select>
              <svg class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 text-slate-700" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2"/></svg>
            </div>
          </div>

          <div>
            <label class="block mb-1 font-medium text-slate-700 gulzartext text-sm">Topic</label>
            <div class="relative">
              <select id="filterTopic"
                      class="appearance-none bg-slate-50 w-full border border-slate-300 rounded-md py-2 px-3 text-slate-700 gulzartext focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition">
                <option value="">Select Topic</option>
              </select>
              <svg class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 h-4 w-4 text-slate-700" viewBox="0 0 24 24" fill="none"><path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2"/></svg>
            </div>
          </div>
        </div>
      </aside>

      <!-- Main -->
      <main class="flex-1">
        <div class="flex justify-end items-center mb-6 space-x-2 mt-6">
          <span class="text-sm font-medium text-slate-700">View:</span>
          <button id="gridViewButton" type="button"
                  class="cursor-pointer p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 transition-colors btn-active"
                  aria-label="Grid View">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                 viewBox="0 0 24 24" fill="none" stroke="currentColor"
                 stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
              <rect width="7" height="7" x="3" y="3" rx="1" />
              <rect width="7" height="7" x="14" y="3" rx="1" />
              <rect width="7" height="7" x="14" y="14" rx="1" />
              <rect width="7" height="7" x="3" y="14" rx="1" />
            </svg>
          </button>
          <button id="listViewButton" type="button"
                  class="cursor-pointer p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 transition-colors btn-inactive"
                  aria-label="List View">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                 viewBox="0 0 24 24" fill="none" stroke="currentColor"
                 stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
              <line x1="8" x2="21" y1="6" y2="6" />
              <line x1="8" x2="21" y1="12" y2="12" />
              <line x1="8" x2="21" y1="18" y2="18" />
              <line x1="3" x2="3.01" y1="6" y2="6" />
              <line x1="3" x2="3.01" y1="12" y2="12" />
              <line x1="3" x2="3.01" y1="18" y2="18" />
            </svg>
          </button>
        </div>

        <div id="articlesContainer" class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5"></div>

        <div id="loadMoreSpinner" class="hidden col-span-full flex justify-center py-6">
          <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-emerald-500"></div>
        </div>

        <div id="noMoreMsg" class="hidden col-span-full text-center py-6 text-slate-500">
          No more articles to load
        </div>

        <div id="noResultMsg" class="hidden col-span-full text-center py-10 text-slate-600">
          No articles found matching your filters
        </div>
      </main>
    </div>
  </div>

  <!-- Mobile Bottom Navigation Bar -->
  <div id="mobile-navbar"
       class="fixed bottom-0 left-0 right-0 bg-white shadow-xl z-40 lg:hidden rounded-t-2xl border-t border-gray-200">
    <nav class="flex justify-around items-center h-16 text-gray-400">
      <a href="/" class="mobile-nav-item flex flex-col items-center justify-center p-2 text-sm 
          hover:text-[var(--primary-dark)] transition-colors duration-200">
        <i class="fas fa-home text-lg mobile-nav-icon"></i>
        <span class="mt-1 mobile-nav-text">Home</span>
      </a>
      <a href="/qa" class="mobile-nav-item flex flex-col items-center justify-center p-2 text-sm
          hover:text-[var(--primary-dark)] transition-colors duration-200">
        <i class="fas fa-question-circle text-lg mobile-nav-icon"></i>
        <span class="mt-1 mobile-nav-text">Q&A</span>
      </a>
      <a href="/book" class="mobile-nav-item flex flex-col items-center justify-center p-2 text-sm
          hover:text-[var(--primary-dark)] transition-colors duration-200">
        <i class="fas fa-book text-lg mobile-nav-icon"></i>
        <span class="mt-1 mobile-nav-text">Books</span>
      </a>
      <a href="/article" class="mobile-nav-item flex flex-col items-center justify-center p-2 text-sm
          hover:text-[var(--primary-dark)] transition-colors duration-200">
        <i class="fas fa-newspaper text-lg mobile-nav-icon"></i>
        <span class="mt-1 mobile-nav-text">Articles</span>
      </a>
      <a href="/gallery" class="mobile-nav-item flex flex-col items-center justify-center p-2 text-sm
          hover:text-[var(--primary-dark)] transition-colors duration-200">
        <i class="fas fa-images text-lg mobile-nav-icon"></i>
        <span class="mt-1 mobile-nav-text">Gallery</span>
      </a>
    </nav>
  </div>

  <script>
    // ======= Config / State =======
    const API = {
      writers: "https://minaramasjid-backend.onrender.com/api/writers",
      translators: "https://minaramasjid-backend.onrender.com/api/translators",
      languages: "https://minaramasjid-backend.onrender.com/api/languages/language",
      topics: "https://minaramasjid-backend.onrender.com/api/topics",
      articles: "https://minaramasjid-backend.onrender.com/api/articles",
      articleImage: (id) => `https://minaramasjid-backend.onrender.com/api/articles/image/${id}`,
    };

    const DEFAULT_IMAGE = "https://minaramasjid.com/assets/image/default/articles.jpeg";
    const articlesPerLoad = 4;

    let allArticles = [];
    let filteredArticles = [];
    let displayedArticles = [];
    let page = 1;
    let hasMore = true;
    let loadingMore = false;

    const selectedFilters = {
      writer: "",
      translator: "",
      language: "",
      sorting: "latest",
      topic: "",
      search: "",
    };

    // ======= Elements =======
    const pageLoader = document.getElementById("pageLoader");
    const pageContent = document.getElementById("pageContent");

    const mobileMenuBtn = document.getElementById("mobile-menu-button");
    const mobileMenuIcon = document.getElementById("mobileMenuIcon");
    const mobileMenu = document.getElementById("mobile-menu");

    const filterWriter = document.getElementById("filterWriter");
    const filterTranslator = document.getElementById("filterTranslator");
    const filterLanguage = document.getElementById("filterLanguage");
    const filterTopic = document.getElementById("filterTopic");
    const filterSorting = document.getElementById("filterSorting");
    const searchInput = document.getElementById("searchInput");

    const gridBtn = document.getElementById("gridViewButton");
    const listBtn = document.getElementById("listViewButton");
    const container = document.getElementById("articlesContainer");
    const loadMoreSpinner = document.getElementById("loadMoreSpinner");
    const noMoreMsg = document.getElementById("noMoreMsg");
    const noResultMsg = document.getElementById("noResultMsg");

    const chipAll = document.getElementById("chipAll");
    const allCount = document.getElementById("allCount");
    const chipTopic1 = document.getElementById("chipTopic1");
    const chipTopic2 = document.getElementById("chipTopic2");
    const chipTopic1Name = document.getElementById("chipTopic1Name");
    const chipTopic2Name = document.getElementById("chipTopic2Name");
    const chipTopic1Count = document.getElementById("chipTopic1Count");
    const chipTopic2Count = document.getElementById("chipTopic2Count");

    // ======= Utils =======
    const slugify = (text) =>
      String(text || "")
        .toLowerCase()
        .trim()
        .replace(/\s+/g, "-")
        .replace(/[.,\/#!$%\^&\*;:{}=\_`~()؟“”"']/g, "")
        .replace(/-+/g, "-");

    const isUrdu = (text) => /[\u0600-\u06FF]/.test(String(text || ""));

    const sortArticles = (arr, sorting) => {
      return [...arr].sort((a, b) => {
        const da = new Date(a.createdAt || a.createdOn || a.date || 0);
        const db = new Date(b.createdAt || b.createdOn || b.date || 0);
        return sorting === "latest" ? db - da : da - db;
      });
    };

    // Basic HTML → plain text (removes all tags and inline styles)
    function toPlainText(html) {
      const tmp = document.createElement("div");
      tmp.innerHTML = String(html || "");
      tmp.querySelectorAll("script,style").forEach(n => n.remove());
      const txt = tmp.textContent || tmp.innerText || "";
      return txt.replace(/\s+/g, " ").trim();
    }

    // ======= View mode styling =======
    let currentView = localStorage.getItem("articleView") === "list" ? "list" : "grid";

    function setContainerClass(view) {
      if (view === "list") {
        container.className = "flex flex-col gap-6";
        gridBtn.classList.remove("btn-active"); gridBtn.classList.add("btn-inactive");
        listBtn.classList.remove("btn-inactive"); listBtn.classList.add("btn-active");
      } else {
        container.className = "grid grid-cols-2 sm:grid-cols-2 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5";
        listBtn.classList.remove("btn-active"); listBtn.classList.add("btn-inactive");
        gridBtn.classList.remove("btn-inactive"); gridBtn.classList.add("btn-active");
      }
    }

    function applyViewStylesTo(card, view) {
      const imageContainer = card.querySelector(".card-image-container");
      const img = card.querySelector(".card-image");
      const title = card.querySelector(".card-title");
      const desc = card.querySelector(".text-description");

      if (view === "list") {
        card.classList.remove("flex-col");
        card.classList.add("flex", "flex-col", "md:flex-row", "h-auto", "max-w-full");
        imageContainer?.classList.remove("h-[160px]", "w-full");
        imageContainer?.classList.add("w-full","md:w-48","lg:w-60","xl:w-72","md:h-[180px]","flex-shrink-0");
        img?.classList.add("md:rounded-l-xl","md:rounded-r-none");
        title?.classList.remove("title-line-clamp-2");
        title?.classList.add("line-clamp-2");
        desc?.classList.add("line-clamp-2");
      } else {
        card.classList.remove("md:flex-row","h-auto","max-w-full");
        card.classList.add("flex-col");
        imageContainer?.classList.remove("md:w-48","lg:w-60","xl:w-72","md:h-[180px]","flex-shrink-0");
        imageContainer?.classList.add("h-[160px]","w-full");
        img?.classList.remove("md:rounded-l-xl","md:rounded-r-none");
        title?.classList.add("title-line-clamp-2");
        title?.classList.remove("line-clamp-2");
        desc?.classList.add("line-clamp-2");
      }
    }

    function setViewMode(view) {
      currentView = view;
      localStorage.setItem("articleView", view);
      setContainerClass(view);
      container.querySelectorAll(".article-card").forEach(card => applyViewStylesTo(card, view));
    }

    // ======= Card =======
    function createArticleCard(article) {
      const card = document.createElement("div");
      card.className = "article-card group bg-white rounded-xl overflow-hidden shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all duration-300 ease-in-out flex flex-col cursor-pointer";

      card.addEventListener("click", () => {
        const url = `/article/${article.id}/${slugify(article.title)}`;
        window.location.href = url;
      });

      const imgUrl = API.articleImage(article.id);
      const langBadge = /[؀-ۿ]/.test(article.title) ? "اردو" : "Roman";

      card.innerHTML = `
        <div class="card-image-container relative h-[160px] w-full flex-shrink-0 overflow-hidden">
          <img src="${imgUrl}" alt="${escapeHtml(article.title || "")}"
               class="card-image object-cover w-full h-full group-hover:scale-105 transition-transform duration-300 ease-in-out"
               loading="lazy" decoding="async"
               onerror="this.onerror=null;this.src='${DEFAULT_IMAGE}'" />
          <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/30 to-transparent"></div>
          <div class="absolute top-3 left-3 right-3 flex justify-between items-start">
            <div class="flex gap-2">
              <button class="bg-black/50 text-white px-2.5 py-1 rounded-full text-xs backdrop-blur-sm font-medium hover:bg-black/75 transition-colors">${langBadge}</button>
              ${article.translationLanguage ? `<button class="bg-black/50 text-white px-2.5 py-1 rounded-full text-xs backdrop-blur-sm font-medium gulzartext hover:bg-black/75 transition-colors">${escapeHtml(article.translationLanguage)}</button>` : ""}
            </div>
          </div>
          <div class="absolute bottom-0 left-0 right-0 p-3 text-white">
            <h2 class="heading card-title font-bold text-lg leading-tight ${isUrdu(article.title) ? "text-right" : "text-left"} title-line-clamp-2">${escapeHtml(article.title || "")}</h2>
          </div>
        </div>
        <div class="card-content-container p-4 flex-1 flex flex-col justify-between overflow-hidden">
          <div class="overflow-hidden">
            <p class="text-description line-clamp-2 text-sm"></p>
          </div>
          <div class="mt-3 pt-3 border-t border-slate-200">
            <p class="gulzartext text-xs font-medium text-slate-500 text-left mb-1">
              ${article.author ? `Author: ${escapeHtml(article.author)}` : ""}${article.translator ? ` | Translator: ${escapeHtml(article.translator)}` : ""}
            </p>
            <div class="flex justify-end items-center gap-1 text-slate-500">
              <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                   viewBox="0 0 24 24" fill="none" stroke="currentColor"
                   stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7-10-7-10-7z"></path>
                <circle cx="12" cy="12" r="3"></circle>
              </svg>
              <span class="text-xs">${Number(article.views) || 0}</span>
            </div>
          </div>
        </div>
      `;

      const descEl = card.querySelector(".text-description");
      const rawDesc = article.englishDescription || article.urduDescription || article.description || article.title || "";
      const text = toPlainText(rawDesc);

      const urdu = isUrdu(text);
      descEl.textContent = text;
      if (urdu) {
        descEl.classList.add("gulzartext", "text-right");
        descEl.classList.remove("text-left");
      } else {
        descEl.classList.remove("gulzartext", "text-right");
        descEl.classList.add("text-left");
      }

      applyViewStylesTo(card, currentView);

      return card;
    }

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, "&amp;").replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // ======= Rendering / Pagination =======
    function resetAndRender() {
      filteredArticles = applyFilters(allArticles, selectedFilters);
      filteredArticles = sortArticles(filteredArticles, selectedFilters.sorting);

      page = 1;
      hasMore = filteredArticles.length > 0;
      container.innerHTML = "";
      displayedArticles = filteredArticles.slice(0, articlesPerLoad);
      renderArticles(displayedArticles);

      noResultMsg.classList.toggle("hidden", filteredArticles.length !== 0);
      noMoreMsg.classList.add("hidden");
      allCount.textContent = String(allArticles.length || 0);
    }

    function renderArticles(list) {
      const frag = document.createDocumentFragment();
      list.forEach(a => {
        const card = createArticleCard(a);
        frag.appendChild(card);
      });
      container.appendChild(frag);
    }

    function loadMore() {
      if (loadingMore || !hasMore) return;
      loadingMore = true;
      loadMoreSpinner.classList.remove("hidden");

      const nextPage = page + 1;
      const start = (nextPage - 1) * articlesPerLoad;
      const end = start + articlesPerLoad;

      setTimeout(() => {
        const chunk = filteredArticles.slice(start, end);
        if (chunk.length) {
          renderArticles(chunk);
          displayedArticles = displayedArticles.concat(chunk);
          page = nextPage;
          hasMore = end < filteredArticles.length;
          if (!hasMore) noMoreMsg.classList.remove("hidden");
        } else {
          hasMore = false;
          noMoreMsg.classList.remove("hidden");
        }
        loadMoreSpinner.classList.add("hidden");
        loadingMore = false;
      }, 100);
    }

    function applyFilters(list, f) {
      let out = [...list];
      if (f.writer) out = out.filter(a => String(a.writers) === f.writer || String(a.author) === f.writer);
      if (f.translator) out = out.filter(a => String(a.translator) === f.translator);
      if (f.language) out = out.filter(a => String(a.language) === f.language);
      if (f.topic) out = out.filter(a => String(a.topic) === f.topic);
      if (f.search) {
        const q = f.search.toLowerCase();
        out = out.filter(a =>
          String(a.title || "").toLowerCase().includes(q) ||
          String(a.englishDescription || "").toLowerCase().includes(q) ||
          String(a.urduDescription || "").toLowerCase().includes(q)
        );
      }
      return out;
    }

    // ======= Topic Chip Updater =======
    function updateTopicChipsFromSelect(topicValue) {
      if (!chipTopic1) return;

      if (!topicValue) {
        chipTopic1.classList.add("hidden");
        chipTopic1Name.textContent = "";
        if (chipTopic1Count) chipTopic1Count.textContent = "0";
        chipTopic1.removeAttribute("data-topic");
        return;
      }

      const topicText = topicValue; // you can also use selected option text if needed
      chipTopic1Name.textContent = topicText;
      const count = allArticles.filter(a => String(a.topic) === topicValue).length;
      if (chipTopic1Count) chipTopic1Count.textContent = String(count);
      chipTopic1.classList.remove("hidden");
      chipTopic1.dataset.topic = topicValue;
    }

    // ======= Event wiring =======
    function bindUI() {
      if (gridBtn) gridBtn.addEventListener("click", () => setViewMode("grid"));
      if (listBtn) listBtn.addEventListener("click", () => setViewMode("list"));

      window.addEventListener("scroll", () => {
        const nearBottom = window.innerHeight + document.documentElement.scrollTop >= (document.documentElement.offsetHeight - 100);
        if (nearBottom) loadMore();
      });

      if (filterWriter) filterWriter.addEventListener("change", e => { selectedFilters.writer = e.target.value; resetAndRender(); });
      if (filterTranslator) filterTranslator.addEventListener("change", e => { selectedFilters.translator = e.target.value; resetAndRender(); });
      if (filterLanguage) filterLanguage.addEventListener("change", e => { selectedFilters.language = e.target.value; resetAndRender(); });
      
      if (filterTopic) {
        filterTopic.addEventListener("change", e => {
          const value = e.target.value;
          selectedFilters.topic = value;
          updateTopicChipsFromSelect(value);
          resetAndRender();
        });
      }

      if (filterSorting) filterSorting.addEventListener("change", e => { selectedFilters.sorting = e.target.value; resetAndRender(); });

      let t;
      if (searchInput) {
        searchInput.addEventListener("input", e => {
          clearTimeout(t);
          t = setTimeout(() => { selectedFilters.search = e.target.value.trim(); resetAndRender(); }, 250);
        });
      }

      if (chipAll) {
        chipAll.addEventListener("click", () => {
          selectedFilters.topic = "";
          if (filterTopic) filterTopic.value = "";
          updateTopicChipsFromSelect("");
          resetAndRender();
        });
      }

      if (chipTopic1) {
        chipTopic1.addEventListener("click", () => {
          const topicValue = chipTopic1.dataset.topic || "";
          selectedFilters.topic = topicValue;
          if (filterTopic) filterTopic.value = topicValue;
          resetAndRender();
        });
      }
      // chipTopic2 kept unused/hidden for now
    }

    // Mobile menu - guard before attaching to avoid null errors
    if (mobileMenuBtn) {
      mobileMenuBtn.addEventListener("click", () => {
        const open = mobileMenu && mobileMenu.classList.contains("max-h-screen");
        if (mobileMenu) {
          if (open) {
            mobileMenu.classList.remove("max-h-screen", "opacity-100");
            mobileMenu.classList.add("max-h-0", "opacity-0");
          } else {
            mobileMenu.classList.remove("max-h-0", "opacity-0");
            mobileMenu.classList.add("max-h-screen", "opacity-100");
          }
        }
        if (mobileMenuIcon) {
          mobileMenuIcon.setAttribute("d", open ? "M4 6h16M4 12h16M4 18h16" : "M6 18L18 6M6 6l12 12");
        }
      });
    }

    // ======= Initial Fetch =======
    (async function init() {
      try {
        const [wRes, tRes, lRes, tpRes, aRes] = await Promise.all([
          fetch(API.writers),
          fetch(API.translators),
          fetch(API.languages),
          fetch(API.topics),
          fetch(API.articles),
        ]);
        const [writers, translators, languages, topics, articles] = await Promise.all([
          wRes.json(), tRes.json(), lRes.json(), tpRes.json(), aRes.json()
        ]);

        writers.forEach(w => {
          const opt = document.createElement("option");
          opt.value = w.name; opt.textContent = w.name;
          if (filterWriter) filterWriter.appendChild(opt);
        });

        translators.forEach(t => {
          const opt = document.createElement("option");
          opt.value = t.name; opt.textContent = t.name;
          if (filterTranslator) filterTranslator.appendChild(opt);
        });

        languages.forEach(l => {
          const opt = document.createElement("option");
          opt.value = l.language; opt.textContent = l.language;
          if (filterLanguage) filterLanguage.appendChild(opt);
        });

        topics.forEach(tp => {
          const opt = document.createElement("option");
          opt.value = tp.topic; opt.textContent = tp.topic;
          if (filterTopic) filterTopic.appendChild(opt);
        });

        // Notice: no default topic chips here anymore.
        // They will only be shown when a topic is selected from dropdown.

        allArticles = Array.isArray(articles) ? articles : [];
        allCount.textContent = String(allArticles.length || 0);

        bindUI();

        setContainerClass(currentView);
        resetAndRender();

      } catch (err) {
        console.error("Error fetching data:", err);
        bindUI();
      } finally {
        pageLoader.classList.add("hidden");
        pageContent.classList.remove("hidden");
      }
    })();

    document.addEventListener('DOMContentLoaded', () => {
      // --- Mobile Menu Toggle (second-safe handler) ---
      const mobileMenuButton = document.getElementById('mobile-menu-button');
      const mobileMenuLocal = document.getElementById('mobile-menu');
      if (mobileMenuButton && mobileMenuLocal) {
        mobileMenuButton.addEventListener('click', () => {
          const isExpanded = mobileMenuButton.getAttribute('aria-expanded') === 'true';
          mobileMenuButton.setAttribute('aria-expanded', (!isExpanded).toString());
          mobileMenuLocal.classList.toggle('hidden');
        });
      }

      // --- Back To Top Button ---
      const backToTopBtn = document.getElementById('backToTopBtn');
      if (backToTopBtn) {
        window.addEventListener('scroll', () => {
          if (window.scrollY > 300) {
            backToTopBtn.classList.remove('hidden');
            backToTopBtn.classList.add('flex');
            backToTopBtn.classList.remove('opacity-0');
          } else {
            backToTopBtn.classList.add('opacity-0');
            setTimeout(() => {
              if (window.scrollY <= 300) {
                backToTopBtn.classList.add('hidden');
                backToTopBtn.classList.remove('flex');
              }
            }, 300);
          }
        });

        backToTopBtn.addEventListener('click', () => {
          window.scrollTo({
            top: 0,
            behavior: 'smooth'
          });
        });
      }

      // --- New Language Toggle Logic ---
      const langButtons = document.querySelectorAll('.lang-btn');
      langButtons.forEach(button => {
        button.addEventListener('click', (e) => {
          const clickedButton = e.currentTarget;
          const sectionId = clickedButton.dataset.sectionId;
          const lang = clickedButton.dataset.lang;
          const isUrdu = (lang === 'ur');

          const sectionButtons = document.querySelectorAll(`.lang-btn[data-section-id="${sectionId}"]`);
          sectionButtons.forEach(btn => {
            btn.classList.remove('active-lang-btn');
          });
          clickedButton.classList.add('active-lang-btn');

          const contentElements = document.querySelectorAll(`.lang-content[data-section-id="${sectionId}"]`);
          contentElements.forEach(el => {
            if (isUrdu && el.dataset.lang === 'ur') {
              el.classList.remove('hidden');
            } else if (!isUrdu && el.dataset.lang === 'en') {
              el.classList.remove('hidden');
            } else {
              el.classList.add('hidden');
            }
          });

          const contentWrapper = document.querySelector(`.card-content-wrapper[data-section-id="${sectionId}"]`);
          if (contentWrapper) {
            contentWrapper.dir = isUrdu ? 'rtl' : 'ltr';
          }
        });
      });
    });
  </script>
</body>
</html>
