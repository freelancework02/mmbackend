<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, user-scalable=no, shrink-to-fit=no"
  />

  <% /* ---------- SAFE DEFAULTS FOR UNDEFINED LOCALS ---------- */ %>
  <% 
    const _val = (v, d='') => (typeof v !== 'undefined' && v !== null ? v : d);
    const _TITLE      = _val(title, 'News & Events');
    const _DESC       = _val(description, '');
    const _PAGE_URL   = _val(pageUrl, '');
    const _FAVICON    = _val(faviconUrl, '/favicon.ico');
    const _OG_IMAGE   = _val(typeof ogImage !== 'undefined' ? ogImage : '', '');
    const _BG_URL     = _val(bgUrl, '');
    const _CENTER_LOGO= _val(centerLogo, '/logo.png');
  %>

  <title><%= _TITLE %></title>
  <meta name="description" content="<%= _DESC %>" />

  <!-- Favicon -->
  <link rel="icon" href="<%= _FAVICON %>" type="image/x-icon" />

  <!-- Open Graph -->
  <meta property="og:type" content="website" />
  <meta property="og:url" content="<%= _PAGE_URL %>" />
  <meta property="og:title" content="<%= _TITLE %>" />
  <meta property="og:description" content="<%= _DESC %>" />
  <meta property="og:image" content="<%= _OG_IMAGE %>"/>
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:url" content="<%= _PAGE_URL %>" />
  <meta name="twitter:title" content="<%= _TITLE %>" />
  <meta name="twitter:description" content="<%= _DESC %>" />
  <meta name="twitter:image" content="<%= _OG_IMAGE %>"/>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    .title-line-clamp-2 { display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
    .line-clamp-1 { display:-webkit-box; -webkit-line-clamp:1; -webkit-box-orient:vertical; overflow:hidden; }
    .line-clamp-2 { display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }
    .rtl { direction: rtl; }
  </style>

  <% /* ---------- EJS helpers (server-side) ---------- */ %>
  <% 
    const _str = s => String(s || "");
    const stripHtml = s => _str(s).replace(/<[^>]*>/g, "");
    const slugify = (t) => _str(t)
      .toLowerCase()
      .trim()
      .replace(/[\u0600-\u06FF]+/g,"")   // drop Arabic script for ASCII-only slugs
      .replace(/\s+/g,"-")
      .replace(/[.,\/#!$%\^&\*;:{}=\_`~()؟"’’“”]/g,"")
      .replace(/-+/g,"-")
      .replace(/^-+|-+$/g,"") || "event";
    const eventUrl = (ev) => `/events/${ev.id}/${slugify(ev.title || ("event-" + ev.id))}`;
    const eventImg = (ev) => ev.imageSrc ? ev.imageSrc : `/api/events/image/${ev.id}`;
    const safeText = (ev) => stripHtml(ev.content || ev.safeText || "");
  %>
</head>

<body >
  <!-- Background -->
  <div
    class="absolute inset-0 opacity-36 pointer-events-none"
    style="background-image: url('<%= _BG_URL %>');"
  ></div>

  <!-- Header -->
  <header class="bg-[#718e56] sticky top-0 z-50 shadow-md border-b border-green-100">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center py-4 relative">
        <!-- Left nav -->
        <nav class="hidden md:flex gap-6 text-md font-semibold text-white tracking-wide">
          <a href="/">Home</a>
          <a href="/about">About</a>
          <a href="/events" class="font-bold">News & Event</a>
          <a href="/book">Books</a>
        </nav>

        <!-- Center logo -->
        <div class="absolute left-1/2 transform -translate-x-1/2 -bottom-7 bg-white rounded-full p-1 shadow-lg border border-green-100 z-10">
          <img
            src="<%= _CENTER_LOGO %>"
            alt="Logo"
            class="w-16 h-16 rounded-full object-contain"
          />
        </div>

        <!-- Right nav -->
        <nav class="hidden md:flex gap-6 text-md font-semibold text-white tracking-wide">
          <a href="/article">Articles</a>
          <a href="/qa">Question Answer</a>
          <a href="/requestBook">Request a Book</a>
          <a href="/contact">Contact</a>
        </nav>

        <!-- Mobile button -->
        <div class="md:hidden">
          <button
            id="mm-btn"
            class="text-gray-100 focus:outline-none"
            aria-label="Toggle menu"
          >
            <svg class="w-7 h-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          </button>
        </div>
      </div>

      <!-- Mobile menu -->
      <div id="mm" class="md:hidden transition-all overflow-hidden max-h-0 opacity-0">
        <div class="flex flex-col gap-3 py-4 px-2 text-white bg-[#5a7544] rounded-b-xl">
          <a href="/" class="hover:bg-[#4f6639] px-4 py-2 rounded">Home</a>
          <a href="/about" class="hover:bg-[#4f6639] px-4 py-2 rounded">About</a>
          <a href="/book" class="hover:bg-[#4f6639] px-4 py-2 rounded">Books</a>
          <a href="/events" class="bg-[#4f6639] px-4 py-2 rounded">News & Event</a>
          <a href="/article" class="hover:bg-[#4f6639] px-4 py-2 rounded">Articles</a>
          <a href="/qa" class="hover:bg-[#4f6639] px-4 py-2 rounded">Question Answer</a>
          <a href="/requestBook" class="hover:bg-[#4f6639] px-4 py-2 rounded">Request a Book</a>
          <a href="/contact" class="hover:bg-[#4f6639] px-4 py-2 rounded">Contact</a>
        </div>
      </div>
    </div>
  </header>


  <!-- ========= Grid section ========= -->
  <section id="news" class="py-16 md:py-24 bg-gray-100">
    <div class="container mx-auto px-4">
      <div class="text-center mb-16">
        <h2 class="text-4xl md:text-5xl font-extrabold mb-2 text-[var(--primary-dark)] fade-in fade-in-1">
          News & Events
        </h2>
        <p class="text-xl text-[var(--secondary-brown)] font-light fade-in fade-in-2">
          Stay up-to-date with our latest happenings.
        </p>
      </div>

      <div class="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5">
        <% if (events && events.length) { events.forEach(function(ev, idx){ %>
          <a href="<%= eventUrl(ev) %>"
             class="group bg-white rounded-xl overflow-hidden shadow-lg hover:shadow-xl hover:-translate-y-1 transition-all duration-300 ease-in-out flex flex-col <%= idx<3 ? 'fade-in fade-in-'+(3+idx) : '' %>">
            <div class="relative h-48 w-full overflow-hidden">
              <img src="<%= eventImg(ev) %>" alt="<%= _str(ev.title) %>"
                   class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300 ease-in-out"
                   onerror="this.onerror=null;this.src='https://minaramasjid.com/assets/image/default/articles.jpeg';"/>
              <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/30 to-transparent"></div>
              <div class="absolute bottom-0 left-0 right-0 p-3 text-white">
                <h3 class="font-bold text-lg leading-tight title-line-clamp-2"><%= _str(ev.title) %></h3>
                <p class="text-xs opacity-90 mt-1"><%= ev.date || '' %></p>
              </div>
            </div>
            <div class="p-4 flex-1 flex flex-col justify-between overflow-hidden">
              <p class="text-sm text-gray-600 line-clamp-2"><%= safeText(ev) %></p>
              <div class="mt-3 pt-3 border-t border-slate-200 flex justify-between items-center text-gray-500 text-sm">
                <span class="inline-block text-[var(--secondary-brown)] font-semibold group-hover:underline">
                  Read More
                  <i class="fa-solid fa-angle-right ml-1 transition-transform duration-300 group-hover:translate-x-1"></i>
                </span>
                <span><i class="fas fa-eye mr-1"></i><%= ev.views || 0 %></span>
              </div>
            </div>
          </a>
        <% }) } else { %>
          <div class="col-span-4 text-center text-gray-500">No events available.</div>
        <% } %>
      </div>
    </div>
  </section>

  <!-- Scripts -->
  <script>
    // mobile menu
    const mmBtn = document.getElementById('mm-btn');
    const mm = document.getElementById('mm');
    if (mmBtn && mm) {
      mmBtn.addEventListener('click', () => {
        const open = mm.classList.contains('max-h-screen');
        mm.classList.toggle('max-h-screen', !open);
        mm.classList.toggle('opacity-100', !open);
        mm.classList.toggle('max-h-0', open);
        mm.classList.toggle('opacity-0', open);
      });
    }

    // horizontal scroll controls
    const row = document.getElementById('scroll-row');
    const leftBtn = document.getElementById('arrow-left');
    const rightBtn = document.getElementById('arrow-right');

    function scrollByDir(dir) {
      if (!row) return;
      const amt = row.offsetWidth;
      row.scrollBy({ left: dir === 'left' ? -amt : amt, behavior: 'smooth' });
    }

    if (leftBtn) leftBtn.addEventListener('click', () => scrollByDir('left'));
    if (rightBtn) rightBtn.addEventListener('click', () => scrollByDir('right'));

    // auto-scroll every 2s
    let autoTimer = null;
    function startAuto() {
      stopAuto();
      autoTimer = setInterval(() => {
        if (!row) return;
        const maxLeft = row.scrollWidth - row.clientWidth;
        if (row.scrollLeft >= maxLeft - 2) {
          row.scrollTo({ left: 0, behavior: 'smooth' });
        } else {
          row.scrollBy({ left: row.offsetWidth, behavior: 'smooth' });
        }
      }, 2000);
    }
    function stopAuto() {
      if (autoTimer) clearInterval(autoTimer);
      autoTimer = null;
    }
    startAuto();

    // pause on hover
    if (row) {
      row.addEventListener('mouseenter', stopAuto);
      row.addEventListener('mouseleave', startAuto);
    }
  </script>
</body>
</html>
