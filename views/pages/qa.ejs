<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <% /* ===== META / SEO ===== */ %>
  <title>تمام فتاویٰ | Maula Ali Research Center</title>
  <meta name="description" content="تمام اسلامی سوالات و فتاویٰ—فلٹر کریں، تلاش کریں، اور مکمل جواب پڑھیں۔" />
  <meta property="og:title" content="تمام فتاویٰ | Maula Ali Research Center" />
  <meta property="og:description" content="اسلامی سوالات و فتاویٰ براؤز کریں۔" />
  <meta property="og:image" content="https://placehold.co/1200x630/6a8a4f/white?text=All+Questions" />
  <meta property="og:type" content="website" />
  <meta name="twitter:card" content="summary_large_image" />

  <base href="https://demo.minaramasjid.com/" />
  <link rel="icon" href="https://minaramasjid.com/assets/image/logo/favicon.ico" type="image/x-icon" />

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Flex:opsz,wght@8..144,400;8..144,500;8..144,700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Gulzar&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css" />

  <style>
    @font-face {
      font-family: 'NaatFont';
      src: url('https://res.cloudinary.com/awescreative/raw/upload/v1749150996/Awes/naatfont.ttf') format('truetype');
      font-weight: normal; font-style: normal;
    }
    body { font-family: "Roboto Flex", sans-serif; background-color: #f0f5e9; }
    .gulzartext, .heading { font-family: 'NaatFont','Gulzar',serif; }
    .mobile-menu-hidden { max-height:0; opacity:0; transition:max-height .3s ease-out, opacity .2s ease-out; overflow:hidden; }
    .mobile-menu-visible { max-height:500px; opacity:1; transition:max-height .4s ease-in, opacity .3s ease-in; }

    .qa-layout-grid { display:grid; gap:2rem; grid-template-columns:1fr; max-width:75rem; margin:0 auto; padding:0 1rem; }
    @media (min-width: 1024px){ .qa-layout-grid { grid-template-columns: 1fr 18rem; padding:0; } .page-container{ grid-column:1/2; } #sidebar{ grid-column:2/3; } }
    .page-container { padding-top:0; }
    #sidebar { background:#fff; padding:1.5rem; border-radius:1.5rem; box-shadow:0 4px 12px rgba(0,0,0,.05); border:1px solid #e5e7eb; position:sticky; top:6rem; align-self:flex-start; }
    .sidebar-heading { color:#4a7031; font-size:1.25rem; font-weight:700; margin-bottom:1rem; padding-bottom:.5rem; border-bottom:2px solid #e8f0e0; text-align:right; }
    .tag-list-item{ display:flex; justify-content:space-between; align-items:center; padding:.5rem .5rem; border-radius:.5rem; transition:background-color .2s; cursor:pointer; font-size:1.05rem; text-align:right; }
    .tag-list-item:hover{ background:#f3f4f6; color:#4a7031; }
    .tag-count{ background:#eaf3df; color:#4a7031; padding:.05rem .6rem; border-radius:9999px; font-size:.9rem; font-weight:600; }
    @media (min-width:1024px){ .tag-combobox{ display:none; } } @media (max-width:1023px){ #sidebar{ display:none; } }

    .controls{ display:flex; flex-direction:column; gap:1rem; padding:1.25rem; background:#f9fafb; border-radius:1.25rem; margin-bottom:2rem; border:1px solid #f3f4f6; box-shadow:0 4px 12px rgba(0,0,0,.03); }
    @media (min-width:768px){ .controls{ flex-direction:row; flex-wrap:wrap; align-items:center; } }
    .control{ display:flex; align-items:center; flex-grow:1; position:relative; }
    .control-input-wrapper{ display:flex; align-items:center; gap:.5rem; width:100%; background:#fff; border:1px solid #e5e7eb; border-radius:.75rem; padding:0 .75rem; transition:all .2s; box-shadow:0 1px 2px rgba(0,0,0,.03); }
    .control-input-wrapper:focus-within{ border-color:#4a7031; box-shadow:0 0 0 3px #e8f0e0; }
    .control-input-wrapper i{ color:#6b7280; flex-shrink:0; font-size:1.1rem; }

    #searchInput, select.pill{
      border:none; outline:none; background:transparent; width:100%; padding:.6rem .5rem .6rem .2rem;
      font-size:1rem; font-family:'NaatFont','Gulzar',serif; color:#374151;
    }
    .tag-button{ cursor:pointer; padding-top:.6rem; padding-bottom:.6rem; }
    .tag-button #tagButtonLabel{ font-size:1rem; font-family:'NaatFont','Gulzar',serif; color:#374151; flex-grow:1; text-align:right; }
    .tag-panel{ position:absolute; top:100%; right:0; margin-top:.25rem; z-index:20; width:16rem; overflow:hidden; background:#fff; border:1px solid #e5e7eb; border-radius:.75rem; box-shadow:0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -2px rgba(0,0,0,.05); font-family:'NaatFont','Gulzar',serif; }
    .tag-panel .inner{ max-height:18rem; overflow-y:auto; }
    .tag-search{ width:100%; border:none; border-bottom:1px solid #e5e7eb; position:sticky; top:0; padding:.75rem 1rem; font-family:'NaatFont','Gulzar',serif; font-size:1rem; background:#f9fafb; }
    .tag-option{ padding:.75rem 1rem; cursor:pointer; text-align:right; font-size:1.05rem; display:flex; justify-content:space-between; align-items:center; }
    .tag-option:hover{ background:#e8f0e0; }
    .tag-option[aria-selected="true"]{ font-weight:700; background:#eaf3df; color:#4a7031; }

    .list{ display:grid; grid-template-columns:1fr; gap:1rem; }
    .card-link{ display:block; background:#fff; padding:1.25rem; border-radius:1.25rem; box-shadow:0 4px 12px rgba(0,0,0,.05); transition:all .3s; border:1px solid #fff; }
    .card-link:hover{ transform:translateY(-4px); box-shadow:0 12px 28px -5px rgba(0,0,0,.08), 0 8px 10px -6px rgba(0,0,0,.05); border-color:#e8f0e0; }
    .card-link h3{ transition:color .3s; font-size:1.35rem; font-weight:800; color:#1f2937; }
    .card-link:hover h3{ color:#4a7031; }
    .card-excerpt{ font-size:1.05rem; color:#374151; line-height:1.7; }

    .bg-midnight_green{ background:#4a7031; }
    .pagination{ display:flex; justify-content:center; align-items:center; gap:.5rem; margin-top:2rem; }
    .page-btn{ padding:.4rem 1rem; border-radius:9999px; font-size:1.05rem; font-weight:700; border:1px solid #d1d5db; background:#fff; color:#374151; }
    .page-btn.active{ background:#4a7031; color:#fff; border-color:#4a7031; }
    .page-btn:disabled{ opacity:.5; cursor:not-allowed; background:#f3f4f6; }
    .hidden{ display:none; }
    .pill { padding:.4rem .75rem; border-radius:9999px; border:1px solid #e5e7eb; background:#fff; font-weight:700; }

    /* === Urdu / Roman toggle in each card === */
    .lang-toggle{
      padding:.2rem .6rem;
      border-radius:9999px;
      border:1px solid #e5e7eb;
      background:#f9fafb;
      font-size:.75rem;
      display:inline-flex;
      align-items:center;
      gap:.25rem;
      color:#4b5563;
      cursor:pointer;
      white-space:nowrap;
    }
    .lang-toggle .urdu-label,
    .lang-toggle .roman-label{
      transition:opacity .15s ease, font-weight .15s ease;
    }
    .lang-toggle[data-mode="urdu"] .urdu-label{ font-weight:700; opacity:1; }
    .lang-toggle[data-mode="urdu"] .roman-label{ opacity:.6; }
    .lang-toggle[data-mode="roman"] .roman-label{ font-weight:700; opacity:1; }
    .lang-toggle[data-mode="roman"] .urdu-label{ opacity:.6; }
  </style>

  <%
    // ---------- Server-side helpers only for initial render ----------
    function escapeHTML(s){
      return String(s||"")
        .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;").replace(/'/g,"&#39;");
    }
    function slugify(text){
      return String(text||"").toLowerCase().trim()
        .replace(/[\u0600-\u06FF]+/g,"")          // strip Arabic/Urdu letters from slug
        .replace(/\s+/g,"-")
        .replace(/[.,\/#!$%\^&\*;:{}=\_`~()؟"’’“”]/g,"")
        .replace(/-+/g,"-")
        .replace(/^-+|-+$/g,"");
    }
    function toEastern(num){ const d=['۰','۱','۲','۳','۴','۵','۶','۷','۸','۹']; return String(num).replace(/\d/g,ch=>d[Number(ch)]); }
    function qText(q){ return q?.questionUrdu || q?.questionEnglish || q?.title || ""; }

    const pageSize = 12;
    const totalCount = (questions?.length || 0);   // <-- total count
    const totalPages = Math.max(1, Math.ceil(totalCount / pageSize));
  %>
</head>
<body class="bg-[#f0f5e9] text-gray-800 antialiased">
  <div class="min-h-screen z-10">
    <div class="absolute inset-0 bg-cover bg-no-repeat opacity-70" style="background-image:url('/assets/bg-DgzunbF9.png'); background-position:center; z-index:-1;"></div>

    <!-- Header -->
    <header  lang="eng" dir="ltr" class="bg-[#718e56] sticky top-0 z-50 shadow-md border-b border-green-100">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center py-4 relative">
          <!-- Left nav -->
          <nav class="hidden md:flex gap-6 text-md font-semibold text-white tracking-wide">
            <a href="/">Home</a>
            <a href="/about">About</a>
            <a href="/events" class="font-bold">News & Event</a>
            <a href="/book">Books</a>
          </nav>

          <!-- Center logo -->
          <div
            class="absolute left-1/2 transform -translate-x-1/2 -bottom-7 bg-white rounded-full p-1 shadow-lg border border-green-100 z-10">
            <img src="https://minaramasjid.com/assets/image/logo/marc.png" alt="Logo"
                 class="w-16 h-16 rounded-full object-contain" />
          </div>

          <!-- Right nav -->
          <nav class="hidden md:flex gap-6 text-md font-semibold text-white tracking-wide">
            <a href="/article">Articles</a>
            <a href="/qa">Question Answer</a>
            <!-- <a href="/requestBook">Request a Book</a> -->
            <a href="/contact">Contact</a>
          </nav>

          <!-- Mobile button -->
          <div class="md:hidden">
            <button id="mm-btn" class="text-gray-100 focus:outline-none" aria-label="Toggle menu">
              <svg class="w-7 h-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M4 6h16M4 12h16M4 18h16" />
              </svg>
            </button>
          </div>
        </div>

        <!-- Mobile menu -->
        <div id="mm" class="md:hidden transition-all overflow-hidden max-h-0 opacity-0">
          <div class="flex flex-col gap-3 py-4 px-2 text-white bg-[#5a7544] rounded-b-xl">
            <a href="/" class="hover:bg-[#4f6639] px-4 py-2 rounded">Home</a>
            <a href="/about" class="hover:bg-[#4f6639] px-4 py-2 rounded">About</a>
            <a href="/book" class="hover:bg-[#4f6639] px-4 py-2 rounded">Books</a>
            <a href="/events" class="bg-[#4f6639] px-4 py-2 rounded">News & Event</a>
            <a href="/article" class="hover:bg-[#4f6639] px-4 py-2 rounded">Articles</a>
            <a href="/qa" class="hover:bg-[#4f6639] px-4 py-2 rounded">Question Answer</a>
            <!-- <a href="/requestBook" class="hover:bg-[#4f6639] px-4 py-2 rounded">Request a Book</a> -->
            <a href="/contact" class="hover:bg-[#4f6639] px-4 py-2 rounded">Contact</a>
          </div>
        </div>
      </div>
    </header>

    <!-- Main -->
    <main class="relative z-10 pt-12 sm:pt-16">
      <section class="relative max-w-7xl mx.auto py-8">
        <h1 class="heading text-3xl lg:text-4xl font-bold text-[#4a7031] mb-6 text-center gulzartext">تمام فتاویٰ</h1>

        <div class="qa-layout-grid">
          <!-- MAIN -->
          <div class="page-container gulzartext">
            <div class="controls">
              <!-- Search -->
              <div class="control search-control">
                <label for="searchInput" class="sr-only">تلاش:</label>
                <div class="control-input-wrapper">
                  <input id="searchInput" type="text" placeholder="عنوان یا سوال لکھیں…" spellcheck="false" />
                  <i class="bi bi-search"></i>
                </div>
              </div>

              <!-- Sort -->
              <div class="control control-sort">
                <label for="sortMode" class="sr-only">ترتیب:</label>
                <div class="control-input-wrapper">
                  <i class="bi bi-arrow-down-up"></i>
                  <select id="sortMode" class="pill">
                    <option value="default">معیاری</option>
                    <option value="latest">Latest</option>
                    <option value="oldest">Oldest</option>
                    <option value="views">Most Viewed</option>
                    <option value="tag-az">Tag A→Z</option>
                    <option value="tag-za">Tag Z→A</option>
                  </select>
                </div>
              </div>

              <!-- Mobile Tags Combobox -->
              <div class="control tag-combobox" id="tagBox">
                <button type="button" id="tagButton" class="btn tag-button control-input-wrapper">
                  <i class="bi bi-tags"></i>
                  <span id="tagButtonLabel" class="flex-grow text-right">تمام ٹیگز</span>
                  <i class="bi bi-chevron-down text-xs"></i>
                </button>
                <div id="tagPanel" class="tag-panel hidden" role="listbox" aria-labelledby="tagButton">
                  <input id="tagSearchInput" class="tag-search" type="text" placeholder="ٹیگز تلاش کریں…" spellcheck="false" />
                  <div class="inner">
                    <a href="#" class="tag-option" data-value="" aria-selected="true">
                      <span>تمام ٹیگز</span><span class="tag-count"><%= (questions||[]).length %></span>
                    </a>
                    <div id="tagOptions"></div>
                  </div>
                </div>
              </div>

              <div id="inlineLoader" class="pill hidden">لوڈ ہو رہا ہے…</div>
            </div>

            <!-- SSR List (first page) -->
            <div id="list" class="list">
              <% if ((questions || []).length === 0) { %>
                <div class="text-center text-gray-600 py-8">اس وقت کوئی سوال دستیاب نہیں۔</div>
              <% } else {
                   const firstPage = questions.slice(0, pageSize);
                   firstPage.forEach((q, idx) => {
                     const baseText = qText(q);
                     const href = `/question/${q?.id}/${q?.slug || slugify(baseText)}`;

                     const urduText = q?.questionUrdu || baseText;
                     const romanText = q?.questionRoman || q?.questionEnglish || "";
                     const hasRoman = Boolean(romanText && romanText.trim().length > 0);

                     const urduExcerpt = q?.excerpt || urduText;
                     const romanExcerpt = q?.excerptRoman || romanText || urduExcerpt;

                     // descending number: totalCount, totalCount-1, ...
                     const displayNumber = totalCount - idx;
              %>
                <a href="<%= href %>" class="card-link group">
                  <div class="flex items-start gap-4 justify-between">
                    <div class="flex.items-center gap-4 flex-1 min-w-0">
                      <div class="flex-shrink-0 w-10 h-10 bg-midnight_green text-white rounded-full flex items-center justify-center font-bold text-lg gulzartext">
                        <%= toEastern(displayNumber) %>
                      </div>
                      <h3 class="heading overflow-hidden">
                        <span class="q-text-urdu"><%- escapeHTML(urduText) %></span>
                        <% if (hasRoman) { %>
                          <span class="q-text-roman.hidden"><%- escapeHTML(romanText) %></span>
                        <% } %>
                      </h3>
                    </div>
                    <% if (hasRoman) { %>
                      <button type="button" class="lang-toggle" data-mode="urdu">
                        <span class="urdu-label">اردو</span>
                        <span>/</span>
                        <span class="roman-label">Roman</span>
                      </button>
                    <% } %>
                  </div>

                  <% if (urduExcerpt || romanExcerpt) { %>
                    <p class="mt-3 mb-4 text-gray-700 line-clamp-3 gulzartext card-excerpt">
                      <span class="q-text-urdu"><%- escapeHTML(urduExcerpt) %></span>
                      <% if (hasRoman) { %>
                        <span class="q-text-roman hidden"><%- escapeHTML(romanExcerpt) %></span>
                      <% } %>
                    </p>
                  <% } %>

                  <div class="mt-4 flex justify-between items-center text-sm pt-3 border-t border-gray-100">
                    <span class="bg-[#eaf3df] text-[#white] rounded-full px-4 py-1.5 text-sm font-bold transition-colors group-hover:bg-[#4a7031] group-hover:text-white.heading">
                      مکمل جواب پڑھیں
                      <i class="fa-solid fa-arrow-left text-xs mr-2 opacity-70 transition-transform group-hover:mr-3"></i>
                    </span>
                    <div class="flex items-center text-gray-500 gap-1.5" title="Views">
                      <i class="bi bi-eye-fill"></i>
                      <span><%= (q?.views||0).toLocaleString("en-IN") %></span>
                    </div>
                  </div>
                </a>
              <% }); } %>
            </div>

            <!-- Pagination -->
            <div class="mt-6 pagination" id="pagination">
              <button class="page-btn" id="nextPage" <%= totalPages>1 ? "" : "disabled" %> >اگلا →</button>
              <div id="pageNumbers" class="inline-flex" style="gap:6px;">
                <% for (let p=1; p<=totalPages; p++){ %>
                  <button class="page-btn <%= p===1 ? 'active' : '' %>" data-page="<%= p %>"><%= toEastern(p) %></button>
                <% } %>
              </div>
              <button class="page-btn" id="prevPage" disabled>← پچھلا</button>
            </div>
          </div>

          <!-- SIDEBAR -->
          <aside id="sidebar" class="gulzartext">
            <h2 class="sidebar-heading">تمام موضوعات</h2>
            <div id="sidebarTagList">
              <a href="#" class="tag-list-item font-bold bg-[#e8f0e0] text-[#4a7031] mb-2" data-value="">
                <span>تمام ٹیگز</span>
                <i class="bi bi-tag-fill"></i>
              </a>
              <% (topics || []).slice(0, 100).forEach(t => {
                   const label = t?.name || t?.title || t?.topic || "";
                   const value = slugify(t?.slug || label);
                   const count = t?.count || t?.total || "";
              %>
                <a href="#" class="tag-list-item" data-value="<%= value %>">
                  <span><%= label %></span>
                  <span class="tag-count"><%= count %></span>
                </a>
              <% }); %>
            </div>
          </aside>
        </div>
      </section>
    </main>
  </div>

  <button id="backToTopBtn" class="fixed bottom-6 left-6 bg-[#4a7031] hover:bg-[#3b5a28] text-white w-10 h-10 rounded-full shadow-lg hidden justify-center items-center transition-all duration-300 opacity-0 z-40">
    <i class="fas fa-arrow-up"></i>
  </button>

  <!-- Mobile Bottom Navigation Bar -->
  <div id="mobile-navbar"
       class="fixed bottom-0 left-0 right-0 bg-white shadow-xl z-40 lg:hidden rounded-t-2xl border-t border-gray-200">
    <nav class="flex justify-around items-center h-16 text-gray-400">

      <!-- Home -->
      <a href="/" class="mobile-nav-item flex flex-col items-center justify-center p-2 text-sm 
        hover:text-[var(--primary-dark)] transition-colors.duration-200">
        <i class="fas fa-home text-lg mobile-nav-icon"></i>
        <span class="mt-1 mobile-nav-text">Home</span>
      </a>

      <!-- Q&A (Updated from About) -->
      <a href="/qa" class="mobile-nav-item flex flex-col items-center justify-center p-2 text-sm
        hover:text-[var(--primary-dark)] transition-colors.duration-200">
        <i class="fas fa-question-circle text-lg mobile-nav-icon"></i>
        <span class="mt-1 mobile-nav-text">Q&A</span>
      </a>

      <!-- Books -->
      <a href="/book" class="mobile-nav-item flex flex-col items-center justify-center p-2 text-sm
        hover:text-[var(--primary-dark)] transition-colors.duration-200">
        <i class="fas fa-book text-lg mobile-nav-icon"></i>
        <span class="mt-1 mobile-nav-text">Books</span>
      </a>

      <!-- Articles -->
      <a href="/article" class="mobile-nav-item flex flex-col items-center justify-center p-2 text-sm
        hover:text-[var(--primary-dark)] transition-colors.duration-200">
        <i class="fas fa-newspaper text-lg mobile-nav-icon"></i>
        <span class="mt-1 mobile-nav-text">Articles</span>
      </a>

      <!-- Gallery (Updated from Contact) -->
      <a href="/gallery" class="mobile-nav-item flex flex.col items-center justify-center p-2 text-sm
        hover:text-[var(--primary-dark)] transition-colors.duration-200">
        <i class="fas fa-images text-lg mobile-nav-icon"></i>
        <span class="mt-1 mobile-nav-text">Gallery</span>
      </a>

    </nav>
  </div>

  <!-- Boot data -->
  <script>
    window.__API_BASE__ = <%- JSON.stringify(apiBase) %>;
    window.__QUESTIONS__ = <%- JSON.stringify(questions || []) %>;
    window.__TOPICS__ = <%- JSON.stringify(topics || []) %>;
  </script>

  <!-- Page logic -->
  <script type="module">
    const mmBtn = document.getElementById('mm-btn');
    const mm = document.getElementById('mm');
    if (mmBtn && mm) {
      mmBtn.addEventListener('click', () => {
        const open = mm.classList.contains('max-h-screen');
        mm.classList.toggle('max-h-screen', !open);
        mm.classList.toggle('opacity-100', !open);
        mm.classList.toggle('max-h-0', open);
        mm.classList.toggle('opacity-0', open);
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      const API_BASE = String(window.__API_BASE__ || "").replace(/\/+$/,"");
      const allQuestionsSSR = Array.isArray(window.__QUESTIONS__) ? window.__QUESTIONS__ : [];
      const topicsRaw = Array.isArray(window.__TOPICS__) ? window.__TOPICS__ : [];

      // ---- helpers (client) ----
      const escapeHTML = (s)=>String(s||"")
        .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;").replace(/'/g,"&#39;");
      const slugify = (t)=>String(t||"").toLowerCase().trim()
        .replace(/[\u0600-\u06FF]+/g,"").replace(/\s+/g,"-")
        .replace(/[.,\/#!$%\^&\*;:{}=\_`~()؟"’’“”]/g,"")
        .replace(/-+/g,"-").replace(/^-+|-+$/g,"");
      const fmtViews = (n)=>{ try{ return Number(n||0).toLocaleString("en-IN"); } catch { return n||0; } };
      const toEastern = (num)=>String(num).replace(/\d/g,ch=>"۰۱۲۳۴۵۶۷۸۹"[Number(ch)]);
      const qText = (q)=>q?.questionUrdu || q?.questionEnglish || q?.title || "";
      const pageSize = 12;

      const parseDate = (v)=>{
        if(!v) return 0;
        const d1 = new Date(v);
        if(!isNaN(d1)) return +d1;
        const m = String(v).match(/^(\d{2})-(\d{2})-(\d{4})/);
        if(m){ const [,dd,mm,yy]=m; return +new Date(`${yy}-${mm}-${dd}T00:00:00Z`); }
        return 0;
      };

      const normTag = (val)=>slugify(val);
      function getQuestionTags(q){
        const out = [];
        if (Array.isArray(q?.tags)) out.push(...q.tags);
        else if (typeof q?.tags === "string") out.push(...q.tags.split(","));
        if (q?.topic) out.push(q.topic);
        if (Array.isArray(q?.topics)) out.push(...q.topics);
        if (q?.tag) out.push(q.tag);
        return out.map(x => normTag(String(x||"").trim())).filter(Boolean);
      }

      // Derived topic counts from questions (fallback if server didn't provide)
      const derivedTopicCounts = (() => {
        const m = new Map();
        for (const q of allQuestionsSSR) {
          for (const t of getQuestionTags(q)) m.set(t, (m.get(t)||0)+1);
        }
        return m;
      })();

      // Normalized topics to render in both sidebar + mobile dropdown
      const allTopics = (() => {
        if (topicsRaw.length) {
          return topicsRaw.map(t => {
            const label = String(t?.name || t?.title || t?.topic || t?.slug || "").trim();
            const value = normTag(t?.slug || label);
            const count = t?.count || t?.total || derivedTopicCounts.get(value) || "";
            return { label, value, count };
          }).filter(x => x.label);
        }
        return Array.from(derivedTopicCounts.entries())
          .map(([value,count]) => ({ label: value.replace(/-/g," "), value, count }))
          .sort((a,b)=>a.label.localeCompare(b.label));
      })();

      // ---- DOM refs ----
      const mobileMenuButton = document.getElementById('mobile-menu-toggle');
      const mobileMenu = document.getElementById('mobile-menu');
      const backToTopBtn = document.getElementById('backToTopBtn');

      const listEl = document.getElementById('list');
      const paginationEl = document.getElementById('pagination');
      const pageNumbersEl = document.getElementById('pageNumbers');
      const prevBtn = document.getElementById('prevPage');
      const nextBtn = document.getElementById('nextPage');

      const sidebarTagList = document.getElementById('sidebarTagList');
      const tagOptionsContainer = document.getElementById('tagOptions');
      const tagBox = document.getElementById('tagBox');
      const tagButton = document.getElementById('tagButton');
      const tagPanel = document.getElementById('tagPanel');
      const tagSearchInput = document.getElementById('tagSearchInput');
      const tagButtonLabel = document.getElementById('tagButtonLabel');

      const searchInput = document.getElementById('searchInput');
      const sortMode = document.getElementById('sortMode');
      const inlineLoader = document.getElementById('inlineLoader');

      // ---- state ----
      const state = { page: 1, term: "", tag: "", sort: "default" };
      const tagCache = new Map();
      let workingSet = allQuestionsSSR.slice();

      // ---- rendering ----
      function cardHTML(q, displayNumber){
        const baseText = qText(q);

        // slug + href
        const href = `/question/${q?.id}/${q?.slug || slugify(baseText)}`;

        // Urdu / Roman text
        const urduText = q?.questionUrdu || baseText;
        const romanText = q?.questionRoman || q?.questionEnglish || "";
        const hasRoman = Boolean(romanText && romanText.trim().length > 0);

        const urduExcerpt = q?.excerpt || urduText;
        const romanExcerpt = q?.excerptRoman || romanText || urduExcerpt;

        const safeUrdu = escapeHTML(urduText);
        const safeRoman = escapeHTML(romanText);
        const safeUrduExcerpt = escapeHTML(urduExcerpt);
        const safeRomanExcerpt = escapeHTML(romanExcerpt);

        return `
          <a href="${href}" class="card-link.group">
            <div class="flex items-start gap-4 justify-between">
              <div class="flex items-center gap-4 flex-1 min-w-0">
                <div class="flex-shrink-0 w-10 h-10 bg-midnight_green text-white rounded-full flex items-center justify-center font-bold text-lg gulzartext">
                  ${toEastern(displayNumber)}
                </div>
                <h3 class="heading overflow-hidden">
                  <span class="q-text-urdu">${safeUrdu}</span>
                  ${hasRoman ? `<span class="q-text-roman hidden">${safeRoman}</span>` : ``}
                </h3>
              </div>
              ${hasRoman ? `
                <button type="button" class="lang-toggle" data-mode="urdu">
                  <span class="urdu-label">اردو</span>
                  <span>/</span>
                  <span class="roman-label">Roman</span>
                </button>
              ` : ``}
            </div>

            ${(urduExcerpt || romanExcerpt) ? `
              <p class="mt-3 mb-4 text-gray-700 line-clamp-3 gulzartext card-excerpt">
                <span class="q-text-urdu">${safeUrduExcerpt}</span>
                ${hasRoman ? `<span class="q-text-roman hidden">${safeRomanExcerpt}</span>` : ``}
              </p>
            ` : ``}

            <div class="mt-4 flex justify-between items-center text-sm pt-3 border-t border-gray-100">
              <span class="bg-[#eaf3df] text-[#4a7031] rounded-full px-4 py-1.5 text-sm font-bold transition-colors group-hover:bg-[#4a7031] group-hover:text-white heading">
                مکمل جواب پڑھیں
                <i class="fa-solid fa-arrow-left text-xs mr-2 opacity-70 transition-transform group-hover:mr-3"></i>
              </span>
              <div class="flex items-center text-gray-500 gap-1.5" title="Views">
                <i class="bi bi-eye-fill"></i>
                <span>${fmtViews(q?.views || 0)}</span>
              </div>
            </div>
          </a>
        `;
      }

      function applySort(arr){
        const s = state.sort;
        if(s === "latest") return arr.slice().sort((a,b)=> parseDate(b.createdAt||b.createdOn||b.date) - parseDate(a.createdAt||a.createdOn||a.date));
        if(s === "oldest") return arr.slice().sort((a,b)=> parseDate(a.createdAt||a.createdOn||a.date) - parseDate(b.createdAt||b.createdOn||b.date));
        if(s === "views")  return arr.slice().sort((a,b)=> (b.views||0) - (a.views||0));
        if(s === "tag-az") return arr.slice().sort((a,b)=> (getQuestionTags(a)[0]||"").localeCompare(getQuestionTags(b)[0]||""));
        if(s === "tag-za") return arr.slice().sort((a,b)=> (getQuestionTags(b)[0]||"").localeCompare(getQuestionTags(a)[0]||""));
        return arr;
      }

      function filterLocal(arr){
        const term = state.term.toLowerCase().trim();
        if(!term) return arr;
        return arr.filter(q => {
          const u = String(q?.questionUrdu || "").toLowerCase();
          const e = String(q?.questionEnglish || "").toLowerCase();
          const t = String(q?.title || "").toLowerCase();
          return u.includes(term) || e.includes(term) || t.includes(term);
        });
      }

      function renderListAndPager(source){
        const filtered = filterLocal(applySort(source));
        const total = filtered.length;                       // total after filters
        const pages = Math.max(1, Math.ceil(total / pageSize));
        if(state.page > pages) state.page = pages;

        const start = (state.page - 1) * pageSize;
        const pageItems = filtered.slice(start, start + pageSize);

        listEl.innerHTML = pageItems.length
          ? pageItems.map((q, i) => {
              // descending numbering across full filtered list:
              const displayNumber = total - (start + i);
              return cardHTML(q, displayNumber);
            }).join("")
          : `<div class="text-center text-gray-600 py-8">کوئی نتیجہ نہیں۔</div>`;

        pageNumbersEl.innerHTML = Array.from({length: pages}, (_,i)=>{
          const p = i+1; const active = p===state.page ? "active":""; 
          return `<button class="page-btn ${active}" data-page="${p}">${toEastern(p)}</button>`;
        }).join("");

        prevBtn.disabled = state.page <= 1;
        nextBtn.disabled = state.page >= pages;
      }

      function showInlineLoader(on=true){
        if(!inlineLoader) return;
        inlineLoader.classList.toggle('hidden', !on);
      }

      async function ensureTagData(tagValue){
        if(!tagValue){ workingSet = allQuestionsSSR.slice(); return; }
        if(tagCache.has(tagValue)){ workingSet = tagCache.get(tagValue).slice(); return; }

        try{
          showInlineLoader(true);
          const res = await fetch(`${API_BASE}/questions/tag/${encodeURIComponent(tagValue)}`);
          if(!res.ok){
            const fallback = allQuestionsSSR.filter(q => getQuestionTags(q).includes(tagValue));
            tagCache.set(tagValue, fallback);
            workingSet = fallback.slice();
          } else {
            const data = await res.json();
            const arr = Array.isArray(data) ? data : [];
            tagCache.set(tagValue, arr);
            workingSet = arr.slice();
          }
        } catch(e){
          const fallback = allQuestionsSSR.filter(q => getQuestionTags(q).includes(tagValue));
          tagCache.set(tagValue, fallback);
          workingSet = fallback.slice();
        } finally {
          showInlineLoader(false);
        }
      }

      async function render(){ await.ensureTagData(state.tag); renderListAndPager(workingSet); }

      // ---- header/menu/back-to-top ----
      if(mobileMenuButton && mobileMenu){
        mobileMenuButton.addEventListener('click', () => {
          mobileMenu.classList.toggle('mobile-menu-hidden');
          mobileMenu.classList.toggle('mobile-menu-visible');
        });
      }
      if(backToTopBtn){
        window.addEventListener('scroll', () => {
          if (window.scrollY > 300) {
            backToTopBtn.classList.remove('hidden'); backToTopBtn.classList.add('flex'); backToTopBtn.classList.remove('opacity-0');
          } else {
            backToTopBtn.classList.add('opacity-0');
            setTimeout(()=>{ if(window.scrollY <= 300){ backToTopBtn.classList.add('hidden'); backToTopBtn.classList.remove('flex'); }}, 300);
          }
        });
        backToTopBtn.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
      }

      // ---- controls ----
      const debounce = (fn,ms)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; };
      if(searchInput) searchInput.addEventListener("input", debounce(e => { state.term = e.target.value || ""; state.page = 1; render(); }, 150));
      if(sortMode) sortMode.addEventListener("change", () => { state.sort = sortMode.value; state.page = 1; render(); });

      // Pagination
      if(paginationEl){
        paginationEl.addEventListener("click", (e)=>{
          const btn = e.target.closest(".page-btn");
          if(!btn) return;
          if(btn.id === "prevPage"){ state.page = Math.max(1, state.page-1); render(); return; }
          if(btn.id === "nextPage"){
            const filtered = filterLocal(applySort(workingSet));
            const pages = Math.max(1, Math.ceil(filtered.length / pageSize));
            state.page = Math.min(pages, state.page+1); render(); return;
          }
          const p = Number(btn.dataset.page||1);
          state.page = p; render();
        });
      }

      // ---- mobile tag dropdown ----
      function renderTagOptions(){
        const html = (allTopics||[]).map(t=>{
          return `<a href="#" class="tag-option" data-value="${t.value}">
                    <span>${t.label}</span>
                    <span class="tag-count">${t.count ?? ""}</span>
                  </a>`;
        }).join("");
        if (tagOptionsContainer) tagOptionsContainer.innerHTML = html;
      }
      renderTagOptions();

      if(tagBox && tagButton && tagPanel && tagSearchInput){
        tagButton.addEventListener('click', (e)=>{
          e.stopPropagation();
          tagPanel.classList.toggle('hidden');
          if(!tagPanel.classList.contains('hidden')){
            tagSearchInput.value = "";
            tagPanel.querySelectorAll('.tag-option').forEach(opt => opt.style.display = "");
            tagSearchInput.focus();
          }
        });
        document.addEventListener('click', (e)=>{ if(!tagBox.contains(e.target)) tagPanel.classList.add('hidden'); });

        tagPanel.addEventListener('click', async (e)=>{
          const target = e.target.closest('.tag-option');
          if(!target) return;
          e.preventDefault();

          tagPanel.querySelectorAll('.tag-option').forEach(o=>o.setAttribute('aria-selected','false'));
          target.setAttribute('aria-selected','true');

          const pickedName = target.querySelector('span')?.textContent || "تمام ٹیگز";
          tagButtonLabel.textContent = pickedName;
          tagPanel.classList.add('hidden');

          state.tag = target.dataset.value || "";
          state.page = 1;

          document.querySelectorAll('#sidebarTagList .tag-list-item').forEach(item=>{
            item.classList.remove('font-bold','bg-[#e8f0e0]','text-[#4a7031]');
            if((item.dataset.value||"") === state.tag) item.classList.add('font-bold','bg-[#e8f0e0]','text-[#4a7031]');
          });

          await render();
        });

        tagSearchInput.addEventListener('input', ()=>{
          const q = tagSearchInput.value.toLowerCase();
          tagPanel.querySelectorAll('.tag-option').forEach(opt=>{
            if(opt.dataset.value === "") return;
            const txt = opt.textContent.toLowerCase();
            opt.style.display = txt.includes(q) ? "" : "none";
          });
        });
      }

      // ---- sidebar topics ----
      if(sidebarTagList){
        const first = sidebarTagList.querySelector('a.tag-list-item[data-value=""]');
        sidebarTagList.innerHTML = "";
        if(first) sidebarTagList.appendChild(first);
        for (const t of allTopics) {
          const a = document.createElement('a');
          a.href = "#";
          a.className = "tag-list-item";
          a.dataset.value = t.value;
          a.innerHTML = `<span>${t.label}</span><span class="tag-count">${t.count ?? ""}</span>`;
          sidebarTagList.appendChild(a);
        }

        sidebarTagList.addEventListener('click', async (e)=>{
          const el = e.target.closest('.tag-list-item'); if(!el) return;
          e.preventDefault();

          sidebarTagList.querySelectorAll('.tag-list-item').forEach(i=>i.classList.remove('font-bold','bg-[#e8f0e0]','text-[#4a7031]'));
          el.classList.add('font-bold','bg-[#e8f0e0]','text-[#4a7031]');

          state.tag = el.dataset.value || "";
          state.page = 1;

          const labelText = el.querySelector('span')?.textContent || "تمام ٹیگز";
          const labelEl = document.getElementById('tagButtonLabel');
          if (labelEl) labelEl.textContent = labelText;

          await render();
        });
      }

      // ---- Urdu / Roman toggle handler (per card) ----
      if (listEl) {
        listEl.addEventListener('click', (e) => {
          const btn = e.target.closest('.lang-toggle');
          if (!btn) return;

          e.preventDefault();
          e.stopPropagation();

          const card = btn.closest('.card-link');
          if (!card) return;

          const current = btn.getAttribute('data-mode') || 'urdu';
          const nextMode = current === 'urdu' ? 'roman' : 'urdu';
          btn.setAttribute('data-mode', nextMode);

          const showRoman = nextMode === 'roman';

          card.querySelectorAll('.q-text-urdu').forEach(el => {
            el.classList.toggle('hidden', showRoman);
          });
          card.querySelectorAll('.q-text-roman').forEach(el => {
            el.classList.toggle('hidden', !showRoman);
          });
        });
      }

      // initial render (client-side)
      render();
    });
  </script>

</body>
</html>
